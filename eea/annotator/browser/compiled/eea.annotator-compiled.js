/* jslint:disable */
!function(a){function b(b,e){var f,g,h,i=this,j=b.add(i),k=a(window),l=a.tools.expose&&(e.mask||e.expose),m=Math.random().toString().slice(10);l&&("string"==typeof l&&(l={color:l}),l.closeOnClick=l.closeOnEsc=!1);var n=e.target||b.attr("rel");if(g=n?a(n):b,!g.length)throw"Could not find Overlay: "+n;b&&b.index(g)==-1&&b.click(function(a){return i.load(a),a.preventDefault()}),a.extend(i,{load:function(b){if(i.isOpened())return i;var f=d[e.effect];if(!f)throw'Overlay: cannot find effect : "'+e.effect+'"';if(e.oneInstance&&a.each(c,function(){this.close(b)}),b=b||a.Event(),b.type="onBeforeLoad",j.trigger(b),b.isDefaultPrevented())return i;h=!0,l&&a(g).expose(l);var n=e.top,o=e.left,p=g.outerWidth(!0),q=g.outerHeight(!0);return"string"==typeof n&&(n="center"==n?Math.max((k.height()-q)/2,0):parseInt(n,10)/100*k.height()),"center"==o&&(o=Math.max((k.width()-p)/2,0)),f[0].call(i,{top:n,left:o},function(){h&&(b.type="onLoad",j.trigger(b))}),l&&e.closeOnClick&&a.mask.getMask().one("click",i.close),e.closeOnClick&&a(document).on("click."+m,function(b){a(b.target).parents(g).length||i.close(b)}),e.closeOnEsc&&a(document).on("keydown."+m,function(a){27==a.keyCode&&i.close(a)}),i},close:function(b){return i.isOpened()?(b=b||a.Event(),b.type="onBeforeClose",j.trigger(b),b.isDefaultPrevented()?void 0:(h=!1,d[e.effect][1].call(i,function(){b.type="onClose",j.trigger(b)}),a(document).off("click."+m+" keydown."+m),l&&a.mask.close(),i)):i},getOverlay:function(){return g},getTrigger:function(){return b},getClosers:function(){return f},isOpened:function(){return h},getConf:function(){return e}}),a.each("onBeforeLoad,onStart,onLoad,onBeforeClose,onClose".split(","),function(b,c){a.isFunction(e[c])&&a(i).on(c,e[c]),i[c]=function(b){return b&&a(i).on(c,b),i}}),f=g.find(e.close||".close"),f.length||e.close||(f=a('<a class="close"></a>'),g.prepend(f)),f.click(function(a){i.close(a)}),e.load&&i.load()}a.tools=a.tools||{version:"@VERSION"},a.tools.overlay={addEffect:function(a,b,c){d[a]=[b,c]},conf:{close:null,closeOnClick:!0,closeOnEsc:!0,closeSpeed:"fast",effect:"default",fixed:!/msie/.test(navigator.userAgent.toLowerCase())||navigator.appVersion>6,left:"center",load:!1,mask:null,oneInstance:!0,speed:"normal",target:null,top:"10%"}};var c=[],d={};a.tools.overlay.addEffect("default",function(b,c){var d=this.getConf(),e=a(window);d.fixed||(b.top+=e.scrollTop(),b.left+=e.scrollLeft()),b.position=d.fixed?"fixed":"absolute",this.getOverlay().css(b).fadeIn(d.speed,c)},function(a){this.getOverlay().fadeOut(this.getConf().closeSpeed,a)}),a.fn.overlay=function(d){var e=this.data("overlay");return e?e:(a.isFunction(d)&&(d={onBeforeLoad:d}),d=a.extend(!0,{},a.tools.overlay.conf,d),this.each(function(){e=new b(a(this),d),c.push(e),a(this).data("overlay",e)}),d.api?e:this)}}(jQuery),function(a){function b(b,c){var d=a(c);return d.length<2?d:b.parent().find(c)}function c(c,e){var f=this,g=c.add(f),h=c.children(),i=0,j=e.vertical;if(d||(d=f),h.length>1&&(h=a(e.items,c)),e.size>1&&(e.circular=!1),a.extend(f,{getConf:function(){return e},getIndex:function(){return i},getSize:function(){return f.getItems().size()},getNaviButtons:function(){return n.add(o)},getRoot:function(){return c},getItemWrap:function(){return h},getItems:function(){return h.find(e.item).not("."+e.clonedClass)},move:function(a,b){return f.seekTo(i+a,b)},next:function(a){return f.move(e.size,a)},prev:function(a){return f.move(-e.size,a)},begin:function(a){return f.seekTo(0,a)},end:function(a){return f.seekTo(f.getSize()-1,a)},focus:function(){return d=f,f},addItem:function(b){return b=a(b),e.circular?(h.children().last().before(b),h.children().first().replaceWith(b.clone().addClass(e.clonedClass))):(h.append(b),o.removeClass("disabled")),g.trigger("onAddItem",[b]),f},seekTo:function(b,c,k){if(b.jquery||(b*=1),e.circular&&0===b&&i==-1&&0!==c)return f;if(!e.circular&&b<0||b>f.getSize()||b<-1)return f;var l=b;b.jquery?b=f.getItems().index(b):l=f.getItems().eq(b);var m=a.Event("onBeforeSeek");if(!k&&(g.trigger(m,[b,c]),m.isDefaultPrevented()||!l.length))return f;var n=j?{top:-l.position().top}:{left:-l.position().left};return i=b,d=f,void 0===c&&(c=e.speed),h.animate(n,c,e.easing,k||function(){g.trigger("onSeek",[b])}),f}}),a.each(["onBeforeSeek","onSeek","onAddItem"],function(b,c){a.isFunction(e[c])&&a(f).on(c,e[c]),f[c]=function(b){return b&&a(f).on(c,b),f}}),e.circular){var k=f.getItems().slice(-1).clone().prependTo(h),l=f.getItems().eq(1).clone().appendTo(h);k.add(l).addClass(e.clonedClass),f.onBeforeSeek(function(a,b,c){if(!a.isDefaultPrevented())return b==-1?(f.seekTo(k,c,function(){f.end(0)}),a.preventDefault()):void(b==f.getSize()&&f.seekTo(l,c,function(){f.begin(0)}))});var m=c.parents().add(c).filter(function(){if("none"===a(this).css("display"))return!0});m.length?(m.show(),f.seekTo(0,0,function(){}),m.hide()):f.seekTo(0,0,function(){})}var n=b(c,e.prev).click(function(a){a.stopPropagation(),f.prev()}),o=b(c,e.next).click(function(a){a.stopPropagation(),f.next()});if(e.circular||(f.onBeforeSeek(function(a,b){setTimeout(function(){a.isDefaultPrevented()||(n.toggleClass(e.disabledClass,b<=0),o.toggleClass(e.disabledClass,b>=f.getSize()-1))},1)}),e.initialIndex||n.addClass(e.disabledClass)),f.getSize()<2&&n.add(o).addClass(e.disabledClass),e.mousewheel&&a.fn.mousewheel&&c.mousewheel(function(a,b){if(e.mousewheel)return f.move(b<0?1:-1,e.wheelSpeed||50),!1}),e.touch){var p={};h[0].ontouchstart=function(a){var b=a.touches[0];p.x=b.clientX,p.y=b.clientY},h[0].ontouchmove=function(a){if(1==a.touches.length&&!h.is(":animated")){var b=a.touches[0],c=p.x-b.clientX,d=p.y-b.clientY;f[j&&d>0||!j&&c>0?"next":"prev"](),a.preventDefault()}}}e.keyboard&&a(document).on("keydown.scrollable",function(b){if(!(!e.keyboard||b.altKey||b.ctrlKey||b.metaKey||a(b.target).is(":input")||"static"!=e.keyboard&&d!=f)){var c=b.keyCode;return!j||38!=c&&40!=c?j||37!=c&&39!=c?void 0:(f.move(37==c?-1:1),b.preventDefault()):(f.move(38==c?-1:1),b.preventDefault())}}),e.initialIndex&&f.seekTo(e.initialIndex,0,function(){})}a.tools=a.tools||{version:"@VERSION"},a.tools.scrollable={conf:{activeClass:"active",circular:!1,clonedClass:"cloned",disabledClass:"disabled",easing:"swing",initialIndex:0,item:"> *",items:".items",keyboard:!0,mousewheel:!1,next:".next",prev:".prev",size:1,speed:400,vertical:!1,touch:!0,wheelSpeed:0}};var d;a.fn.scrollable=function(b){var d=this.data("scrollable");return d?d:(b=a.extend({},a.tools.scrollable.conf,b),this.each(function(){d=new c(a(this),b),a(this).data("scrollable",d)}),b.api?d:this)}}(jQuery),function(a){function b(b,c,d){var f,g=this,h=b.add(this),i=b.find(d.tabs),j=c.jquery?c:b.children(c);i.length||(i=b.children()),j.length||(j=b.parent().find(c)),j.length||(j=a(c)),a.extend(this,{click:function(c,j){var k=i.eq(c),l=!b.data("tabs");if("string"==typeof c&&c.replace("#","")&&(k=i.filter('[href*="'+c.replace("#","")+'"]'),c=Math.max(i.index(k),0)),d.rotate){var m=i.length-1;if(c<0)return g.click(m,j);if(c>m)return g.click(0,j)}if(!k.length){if(f>=0)return g;c=d.initialIndex,k=i.eq(c)}if(c===f)return g;if(j=j||a.Event(),j.type="onBeforeClick",h.trigger(j,[c]),!j.isDefaultPrevented()){var n=l?d.initialEffect&&d.effect||"default":d.effect;return e[n].call(g,c,function(){f=c,j.type="onClick",h.trigger(j,[c])}),i.removeClass(d.current),k.addClass(d.current),g}},getConf:function(){return d},getTabs:function(){return i},getPanes:function(){return j},getCurrentPane:function(){return j.eq(f)},getCurrentTab:function(){return i.eq(f)},getIndex:function(){return f},next:function(){return g.click(f+1)},prev:function(){return g.click(f-1)},destroy:function(){return i.off(d.event).removeClass(d.current),j.find('a[href^="#"]').off("click.T"),g}}),a.each("onBeforeClick,onClick".split(","),function(b,c){a.isFunction(d[c])&&a(g).on(c,d[c]),g[c]=function(b){return b&&a(g).on(c,b),g}}),d.history&&a.fn.history&&(a.tools.history.init(i),d.event="history"),i.each(function(b){a(this).on(d.event,function(a){return g.click(b,a),a.preventDefault()})}),j.find('a[href^="#"]').on("click.T",function(b){g.click(a(this).attr("href"),b)}),location.hash&&"a"==d.tabs&&b.find('[href="'+location.hash+'"]').length?g.click(location.hash):(0===d.initialIndex||d.initialIndex>0)&&g.click(d.initialIndex)}a.tools=a.tools||{version:"@VERSION"},a.tools.tabs={conf:{tabs:"a",current:"current",onBeforeClick:null,onClick:null,effect:"default",initialEffect:!1,initialIndex:0,event:"click",rotate:!1,slideUpSpeed:400,slideDownSpeed:400,history:!1},addEffect:function(a,b){e[a]=b}};var c,d,e={"default":function(a,b){this.getPanes().hide().eq(a).show(),b.call()},fade:function(a,b){var c=this.getConf(),d=c.fadeOutSpeed,e=this.getPanes();d?e.fadeOut(d):e.hide(),e.eq(a).fadeIn(c.fadeInSpeed,b)},slide:function(a,b){var c=this.getConf();this.getPanes().slideUp(c.slideUpSpeed),this.getPanes().eq(a).slideDown(c.slideDownSpeed,b)},ajax:function(a,b){this.getPanes().eq(0).load(this.getTabs().eq(a).attr("href"),b)}};a.tools.tabs.addEffect("horizontal",function(b,e){if(!c){var f=this.getPanes().eq(b),g=this.getCurrentPane();d||(d=this.getPanes().eq(0).width()),c=!0,f.show(),g.animate({width:0},{step:function(a){f.css("width",d-a)},complete:function(){a(this).hide(),e.call(),c=!1}}),g.length||(e.call(),c=!1)}}),a.fn.tabs=function(c,d){var e=this.data("tabs");return e&&(e.destroy(),this.removeData("tabs")),a.isFunction(d)&&(d={onBeforeClick:d}),d=a.extend({},a.tools.tabs.conf,d),this.each(function(){e=new b(a(this),c,d),a(this).data("tabs",e)}),d.api?e:this}}(jQuery),function(a){function b(a){if(a){var b=d.contentWindow.document;b.open().close(),b.location.hash=a}}var c,d,e,f;a.tools=a.tools||{version:"@VERSION"},a.tools.history={init:function(g){f||(a.browser.msie&&a.browser.version<"8"?d||(d=a("<iframe/>").attr("src","javascript:false;").hide().get(0),a("body").append(d),setInterval(function(){var b=d.contentWindow.document,e=b.location.hash;c!==e&&a(window).trigger("hash",e)},100),b(location.hash||"#")):setInterval(function(){var b=location.hash;b!==c&&a(window).trigger("hash",b)},100),e=e?e.add(g):g,g.click(function(c){var e=a(this).attr("href");if(d&&b(e),"#"!=e.slice(0,1))return location.href="#"+e,c.preventDefault()}),f=!0)}},a(window).on("hash",function(b,d){d?e.filter(function(){var b=a(this).attr("href");return b==d||b==d.replace("#","")}).trigger("history",[d]):e.eq(0).trigger("history",[d]),c=d}),a.fn.history=function(b){return a.tools.history.init(this),this.on("history",b)}}(jQuery),function(a){function b(){if(/msie/.test(navigator.userAgent.toLowerCase())){var b=a(document).height(),c=a(window).height();return[window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,b-c<20?c:b]}return[a(document).width(),a(document).height()]}function c(b){if(b)return b.call(a.mask)}a.tools=a.tools||{version:"@VERSION"};var d;d=a.tools.expose={conf:{maskId:"exposeMask",loadSpeed:"slow",closeSpeed:"fast",closeOnClick:!0,closeOnEsc:!0,zIndex:9998,opacity:.8,startOpacity:0,color:"#fff",onLoad:null,onClose:null}};var e,f,g,h,i;a.mask={load:function(j,k){if(g)return this;"string"==typeof j&&(j={color:j}),j=j||h,h=j=a.extend(a.extend({},d.conf),j),e=a("#"+j.maskId),e.length||(e=a("<div/>").attr("id",j.maskId),a("body").append(e));var l=b();return e.css({position:"absolute",top:0,left:0,width:l[0],height:l[1],display:"none",opacity:j.startOpacity,zIndex:j.zIndex}),j.color&&e.css("backgroundColor",j.color),c(j.onBeforeLoad)===!1?this:(j.closeOnEsc&&a(document).on("keydown.mask",function(b){27==b.keyCode&&a.mask.close(b)}),j.closeOnClick&&e.on("click.mask",function(b){a.mask.close(b)}),a(window).on("resize.mask",function(){a.mask.fit()}),k&&k.length&&(i=k.eq(0).css("zIndex"),a.each(k,function(){var b=a(this);/relative|absolute|fixed/i.test(b.css("position"))||b.css("position","relative")}),f=k.css({zIndex:Math.max(j.zIndex+1,"auto"==i?0:i)})),e.css({display:"block"}).fadeTo(j.loadSpeed,j.opacity,function(){a.mask.fit(),c(j.onLoad),g="full"}),g=!0,this)},close:function(){if(g){if(c(h.onBeforeClose)===!1)return this;e.fadeOut(h.closeSpeed,function(){f&&f.css({zIndex:i}),g=!1,c(h.onClose)}),a(document).off("keydown.mask"),e.off("click.mask"),a(window).off("resize.mask")}return this},fit:function(){if(g){var a=b();e.css({width:a[0],height:a[1]})}},getMask:function(){return e},isLoaded:function(a){return a?"full"==g:g},getConf:function(){return h},getExposed:function(){return f}},a.fn.mask=function(b){return a.mask.load(b),this},a.fn.expose=function(b){return a.mask.load(b,this),this}}(jQuery),function(a){function b(b,c,d){var e=d.relative?b.position().top:b.offset().top,f=d.relative?b.position().left:b.offset().left,g=d.position[0];e-=c.outerHeight()-d.offset[0],f+=b.outerWidth()+d.offset[1],/iPad/i.test(navigator.userAgent)&&(e-=a(window).scrollTop());var h=c.outerHeight()+b.outerHeight();"center"==g&&(e+=h/2),"bottom"==g&&(e+=h),g=d.position[1];var i=c.outerWidth()+b.outerWidth();return"center"==g&&(f-=i/2),"left"==g&&(f-=i),{top:e,left:f}}function c(c,e){var f,g,h=this,i=c.add(h),j=0,k=0,l=c.attr("title"),m=c.attr("data-tooltip"),n=d[e.effect],o=c.is(":input"),p=o&&c.is(":checkbox, :radio, select, :button, :submit"),q=c.attr("type"),r=e.events[q]||e.events[o?p?"widget":"input":"def"];if(!n)throw'Nonexistent effect "'+e.effect+'"';if(r=r.split(/,\s*/),2!=r.length)throw"Tooltip: bad events configuration for "+q;c.on(r[0],function(a){clearTimeout(j),e.predelay?k=setTimeout(function(){h.show(a)},e.predelay):h.show(a)}).on(r[1],function(a){clearTimeout(k),e.delay?j=setTimeout(function(){h.hide(a)},e.delay):h.hide(a)}),l&&e.cancelDefault&&(c.removeAttr("title"),c.data("title",l)),a.extend(h,{show:function(d){if(!f&&(m?f=a(m):e.tip?f=a(e.tip).eq(0):l?f=a(e.layout).addClass(e.tipClass).appendTo(document.body).hide().append(l):(f=c.find("."+e.tipClass),f.length||(f=c.next()),f.length||(f=c.parent().next())),!f.length))throw"Cannot find tooltip for "+c;if(h.isShown())return h;f.stop(!0,!0);var o=b(c,f,e);if(e.tip&&f.html(c.data("title")),d=a.Event(),d.type="onBeforeShow",i.trigger(d,[o]),d.isDefaultPrevented())return h;o=b(c,f,e),f.css({position:"absolute",top:o.top,left:o.left}),g=!0,n[0].call(h,function(){d.type="onShow",g="full",i.trigger(d)});var p=e.events.tooltip.split(/,\s*/);return f.data("__set")||(f.off(p[0]).on(p[0],function(){clearTimeout(j),clearTimeout(k)}),p[1]&&!c.is("input:not(:checkbox, :radio), textarea")&&f.off(p[1]).on(p[1],function(a){a.relatedTarget!=c[0]&&c.trigger(r[1].split(" ")[0])}),e.tip||f.data("__set",!0)),h},hide:function(b){return f&&h.isShown()?(b=a.Event(),b.type="onBeforeHide",i.trigger(b),b.isDefaultPrevented()?void 0:(g=!1,d[e.effect][1].call(h,function(){b.type="onHide",i.trigger(b)}),h)):h},isShown:function(a){return a?"full"==g:g},getConf:function(){return e},getTip:function(){return f},getTrigger:function(){return c}}),a.each("onHide,onBeforeShow,onShow,onBeforeHide".split(","),function(b,c){a.isFunction(e[c])&&a(h).on(c,e[c]),h[c]=function(b){return b&&a(h).on(c,b),h}})}a.tools=a.tools||{version:"@VERSION"},a.tools.tooltip={conf:{effect:"toggle",fadeOutSpeed:"fast",predelay:0,delay:30,opacity:1,tip:0,fadeIE:!1,position:["top","center"],offset:[0,0],relative:!1,cancelDefault:!0,events:{def:"mouseenter,mouseleave",input:"focus,blur",widget:"focus mouseenter,blur mouseleave",tooltip:"mouseenter,mouseleave"},layout:"<div/>",tipClass:"tooltip"},addEffect:function(a,b,c){d[a]=[b,c]}};var d={toggle:[function(a){var b=this.getConf(),c=this.getTip(),d=b.opacity;d<1&&c.css({opacity:d}),c.show(),a.call()},function(a){this.getTip().hide(),a.call()}],fade:[function(a){var b=this.getConf();!/msie/.test(navigator.userAgent.toLowerCase())||b.fadeIE?this.getTip().fadeTo(b.fadeInSpeed,b.opacity,a):(this.getTip().show(),a())},function(a){var b=this.getConf();!/msie/.test(navigator.userAgent.toLowerCase())||b.fadeIE?this.getTip().fadeOut(b.fadeOutSpeed,a):(this.getTip().hide(),a())}]};a.fn.tooltip=function(b){var d=this.data("tooltip");return d?d:(b=a.extend(!0,{},a.tools.tooltip.conf,b),"string"==typeof b.position&&(b.position=b.position.split(/,?\s/)),this.each(function(){d=new c(a(this),b),a(this).data("tooltip",d)}),b.api?d:this)}}(jQuery),define("/home/davi/.buildout/eggs/Products.CMFPlone-5.1a1-py2.7.egg/Products/CMFPlone/static/components/jquery.recurrenceinput.js/lib/jquery.tools.overlay.js",function(){});var findChild,getNodeName,getNodePosition,simpleXPathJQuery,simpleXPathPure;simpleXPathJQuery=function(a){var b;return b=this.map(function(){var b,c,d,e;for(d="",b=this;(null!=b?b.nodeType:void 0)===Node.ELEMENT_NODE&&b!==a;)e=b.tagName.replace(":","\\:"),c=$(b.parentNode).children(e).index(b)+1,c="["+c+"]",d="/"+b.tagName.toLowerCase()+c+d,b=b.parentNode;return d}),b.get()},simpleXPathPure=function(a){var b,c,d,e;return b=function(a){var b,c;return b=getNodeName(a),c=getNodePosition(a),""+b+"["+c+"]"},e=a,c=function(a){var c;for(c="";a!==e;){if(null==a)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+e);c=b(a)+"/"+c,a=a.parentNode}return c="/"+c,c=c.replace(/\/$/,"")},d=this.map(function(){var a;return a=c(this)}),d.get()},findChild=function(a,b,c){var d,e,f,g,h,i;if(!a.hasChildNodes())throw new Error("XPath error: node has no children!");for(e=a.childNodes,f=0,h=0,i=e.length;h<i;h++)if(d=e[h],g=getNodeName(d),g===b&&(f+=1,f===c))return d;throw new Error("XPath error: wanted child not found.")},getNodeName=function(a){var b;switch(b=a.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return b}},getNodePosition=function(a){var b,c;for(b=0,c=a;c;)c.nodeName===a.nodeName&&b++,c=c.previousSibling;return b};var $,Util,gettext,_gettext,_ref,_t;gettext=null,"undefined"!=typeof Gettext&&null!==Gettext?(_gettext=new Gettext({domain:"annotator"}),gettext=function(a){return _gettext.gettext(a)}):gettext=function(a){return a},_t=function(a){return gettext(a)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(_ref=jQuery.fn)?_ref.jquery:void 0)||console.error(_t("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(_t("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),$=jQuery,Util={},Util.flatten=function(a){var b;return(b=function(a){var c,d,e,f;for(d=[],e=0,f=a.length;e<f;e++)c=a[e],d=d.concat(c&&$.isArray(c)?b(c):c);return d})(a)},Util.contains=function(a,b){var c;for(c=b;null!=c;){if(c===a)return!0;c=c.parentNode}return!1},Util.getTextNodes=function(a){var b;return b=function(a){var c;if(a&&a.nodeType!==Node.TEXT_NODE){if(c=[],a.nodeType!==Node.COMMENT_NODE)for(a=a.lastChild;a;)c.push(b(a)),a=a.previousSibling;return c.reverse()}return a},a.map(function(){return Util.flatten(b(this))})},Util.getLastTextNodeUpTo=function(a){var b;switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.lastChild&&(b=Util.getLastTextNodeUpTo(a.lastChild),null!=b))return b}return a=a.previousSibling,null!=a?Util.getLastTextNodeUpTo(a):null},Util.getFirstTextNodeNotBefore=function(a){var b;switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.firstChild&&(b=Util.getFirstTextNodeNotBefore(a.firstChild),null!=b))return b}return a=a.nextSibling,null!=a?Util.getFirstTextNodeNotBefore(a):null},Util.readRangeViaSelection=function(a){var b;return b=Util.getGlobal().getSelection(),b.removeAllRanges(),b.addRange(a.toRange()),b.toString()},Util.xpathFromNode=function(a,b){var c,d;try{d=simpleXPathJQuery.call(a,b)}catch(e){c=e,console.log("jQuery-based XPath construction failed! Falling back to manual."),d=simpleXPathPure.call(a,b)}return d},Util.nodeFromXPath=function(a,b){var c,d,e,f,g,h,i,j;for(g=a.substring(1).split("/"),e=b,h=0,i=g.length;h<i;h++)f=g[h],j=f.split("["),d=j[0],c=j[1],c=null!=c?parseInt((null!=c?c.split("]"):void 0)[0]):1,e=findChild(e,d.toLowerCase(),c);return e},Util.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},Util.uuid=function(){var a;return a=0,function(){return a++}}(),Util.getGlobal=function(){return function(){return this}()},Util.maxZIndex=function(a){var b,c;return b=function(){var b,d,e;for(e=[],b=0,d=a.length;b<d;b++)c=a[b],"static"===$(c).css("position")?e.push(-1):e.push(parseInt($(c).css("z-index"),10)||-1);return e}(),Math.max.apply(Math,b)},Util.mousePosition=function(a,b){var c,d;return"absolute"!==(d=$(b).css("position"))&&"fixed"!==d&&"relative"!==d&&(b=$(b).offsetParent()[0]),c=$(b).offset(),{top:a.pageY-c.top,left:a.pageX-c.left}},Util.preventEventDefault=function(a){return null!=a&&"function"==typeof a.preventDefault?a.preventDefault():void 0},Util.days=["Sun","Mon","Tue","Wen","Thu","Fri","Sat"],Util.checkTime=function(a){return a<10&&(a="0"+a),a},Util.dateString=function(a){var b,c,d;return b=this.days[a.getDay()],c=this.checkTime(a.getHours()),d=this.checkTime(a.getMinutes()),b+" "+c+":"+d},Util.userString=function(a){var b;return b=a?a.id?"@"+a.id:"@"+a:""},Util.userTitle=function(a){var b;return b=a?a.name?a.name:a.id?a.id:a:""},Util.easyDate=function(a){var b,c,d,e,f,g,h,i,j;return g=new Date,c=(g-a)/1e3,h="~",c<60?"just now":c<120?h+"1m ago":c<3300?(e=parseInt(c/60,10),h+e+"m ago"):c<7200?h+"1h ago":c<72e3?(d=parseInt(c/3600,10),h+d+"h ago"):(c/=3600,c<48?h+"1d ago":c<160?(b=parseInt(c/24,10),h+b+"d ago"):c<336?h+"1w ago":c<720?(i=parseInt(c/24/7,10),h+i+"w ago"):(c/=24,c<60?h+"1mo ago":c<360?(f=parseInt(c/30,10),h+f+"mo ago"):c<720?h+"1y ago":c>720?(j=parseInt(c/360,10),h+j+"y ago"):void 0))},Util.prettyDateString=function(a){var b,c,d,e,f,g,h;return g=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],f=["January","February","March","April","May","June","July","August","September","October","November","December"],b=g[a.getDay()],e=f[a.getMonth()],c=a.getDate(),h=a.getFullYear(),d=a.toTimeString().split(" ")[0],b+", "+c+" "+e+" "+h+" at "+d};var fn,functions,_i,_j,_len,_len1,__slice=[].slice;if(functions=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(a){return console.log("GROUP: ",a)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),_i=0,_len=functions.length;_i<_len;_i++)fn=functions[_i],null==console[fn]&&(console[fn]=function(){return console.log(_t("Not implemented:")+(" console."+name))});else{for(this.console={},_j=0,_len1=functions.length;_j<_len1;_j++)fn=functions[_j],this.console[fn]=function(){};this.console.error=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],alert("ERROR: "+a.join(", "))},this.console.warn=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],alert("WARNING: "+a.join(", "))}}var Delegator,__slice=[].slice,__hasProp={}.hasOwnProperty;Delegator=function(){function a(a,b){this.options=$.extend(!0,{},this.options,b),this.element=$(a),this._closures={},this.on=this.subscribe,this.addEvents()}return a.prototype.events={},a.prototype.options={},a.prototype.element=null,a.prototype.addEvents=function(){var b,c,d,e,f;for(e=a._parseEvents(this.events),f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this._addEvent(b.selector,b.event,b.functionName));return f},a.prototype.removeEvents=function(){var b,c,d,e,f;for(e=a._parseEvents(this.events),f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this._removeEvent(b.selector,b.event,b.functionName));return f},a.prototype._addEvent=function(b,c,d){var e,f=this;return e=function(){return f[d].apply(f,arguments)},""===b&&a._isCustomEvent(c)?this.subscribe(c,e):this.element.delegate(b,c,e),this._closures[""+b+"/"+c+"/"+d]=e,this},a.prototype._removeEvent=function(b,c,d){var e;return e=this._closures[""+b+"/"+c+"/"+d],""===b&&a._isCustomEvent(c)?this.unsubscribe(c,e):this.element.undelegate(b,c,e),delete this._closures[""+b+"/"+c+"/"+d],this},a.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},a.prototype.subscribe=function(a,b){var c;return c=function(){return b.apply(this,[].slice.call(arguments,1))},c.guid=b.guid=$.guid+=1,this.element.bind(a,c),this},a.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},a}(),Delegator._parseEvents=function(a){var b,c,d,e,f,g,h;c=[];for(e in a)d=a[e],h=e.split(" "),f=2<=h.length?__slice.call(h,0,g=h.length-1):(g=0,[]),b=h[g++],c.push({selector:f.join(" "),event:b,functionName:d});return c},Delegator.natives=function(){var a,b,c;return b=function(){var b,d;b=jQuery.event.special,d=[];for(a in b)__hasProp.call(b,a)&&(c=b[a],d.push(a));return d}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}(),Delegator._isCustomEvent=function(a){return a=a.split(".")[0],$.inArray(a,Delegator.natives)===-1};var Range,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return this.slice(-a.length)===a}),void 0===window.Range&&(Range={},Range.prototype={}),Range.sniff=function(a){return null!=a.commonAncestorContainer?new Range.BrowserRange(a):"string"==typeof a.start?new Range.SerializedRange(a):a.start&&"object"==typeof a.start?new Range.NormalizedRange(a):(console.error(_t("Could not sniff range type")),!1)},Range.nodeFromXPath=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(null==b&&(b=document),null==c&&(c=null),null==d&&(d=null),null==e&&(e="start"),g=function(a,c){var d;null==c&&(c=null);try{return document.evaluate("."+a,b,c,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){return d=e,console.log("XPath evaluation failed."),console.log("Trying fallback..."),Util.nodeFromXPath(a,b)}},$.isXMLDoc(document.documentElement)?(f=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),n=g(a,f),n||(a=function(){var b,c,d,e;for(d=a.split("/"),e=[],b=0,c=d.length;b<c;b++)o=d[b],o&&o.indexOf(":")===-1?e.push(o.replace(/^([a-z]+)/,"xhtml:$1")):e.push(o);return e}().join("/"),l=document.lookupNamespaceURI(null),f=function(a){return"xhtml"===a?l:document.documentElement.getAttribute("xmlns:"+a)},n=g(a,f))):n=g(a),n&&c&&(p=$(n).text().toLowerCase().replace(/\xA0/g," "),m=p.indexOf(c),$(n).removeData(e+"Offset"),"end"===e&&(m+=c.length),m===-1&&(n=null),$.isNumeric(d)&&m!==d&&(n=null)),!n&&c)if(q=a.replace(/\[[0-9]+\]/g,"").replace(/\//g," ").trim(),q=q.replace(/\sstrong$/g,"").replace(/\sb$/g,"").replace("sem$/g","").replace("si$/g",""),n=$(b).find(""+q).filter(function(){return p=$(this).text().toLowerCase().replace(/\xA0/g," "),p.indexOf(c)!==-1}),0===n.length)n=null;else if(1===n.length)n=n[0],p=$(n).text().toLowerCase().replace(/\xA0/g," "),m=p.indexOf(c),"end"===e&&(m+=c.length),$.isNumeric(d)&&m!==d?$(n).data(e+"Offset",m):$(n).removeData(e+"Offset");else{for($.isNumeric(d)||(d=0),h=null,i=Number.MAX_VALUE,r=0,s=n.length;r<s;r++)k=n[r],p=$(k).text().toLowerCase().replace(/\xA0/g," "),m=p.indexOf(c),"end"===e&&(m+=c.length),j=Math.abs(m-d),j<i&&(i=j,h=k,m!==d?$(k).data(e+"Offset",m):$(k).removeData(e+"Offset"));n=h}return n},Range.RangeError=function(a){function b(a,c,d){this.type=a,this.message=c,this.parent=null!=d?d:null,b.__super__.constructor.call(this,this.message)}return __extends(b,a),b}(Error),Range.BrowserRange=function(){function a(a){this.commonAncestorContainer=a.commonAncestorContainer,this.startContainer=a.startContainer,this.startOffset=a.startOffset,this.endContainer=a.endContainer,this.endOffset=a.endOffset}return a.prototype.normalize=function(a,b){var c,d,e,f,g,h;if(this.tainted)return console.error(_t("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,g={},this.startContainer.nodeType===Node.ELEMENT_NODE?(g.start=Util.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),g.startOffset=0):(g.start=this.startContainer,g.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(e=this.endContainer.childNodes[this.endOffset],null!=e){for(d=e;null!=d&&d.nodeType!==Node.TEXT_NODE;)d=d.firstChild;null!=d&&(g.end=d,g.endOffset=0)}null==g.end&&(e=this.endContainer.childNodes[this.endOffset-1],g.end=Util.getLastTextNodeUpTo(e),g.endOffset=g.end.nodeValue.length)}else g.end=this.endContainer,g.endOffset=this.endOffset;for(f={},g.startOffset>0?g.start.nodeValue.length>g.startOffset?f.start=g.start.splitText(g.startOffset):f.start=g.start.nextSibling:f.start=g.start,g.start===g.end?(f.start.nodeValue.length>g.endOffset-g.startOffset&&f.start.splitText(g.endOffset-g.startOffset),f.end=f.start):(g.end.nodeValue.length>g.endOffset&&g.end.splitText(g.endOffset),f.end=g.end),f.commonAncestor=this.commonAncestorContainer;f.commonAncestor.nodeType!==Node.ELEMENT_NODE;)f.commonAncestor=f.commonAncestor.parentNode;if(h=f.start.textContent.trim().toLowerCase().replace(/\xA0/g," "),c=f.end.textContent.trim().toLowerCase().replace(/\xA0/g," "),b){if(b.startsWith(h)&&b.endsWith(c))return new Range.NormalizedRange(f);throw new Range.RangeError("Exact match enabled. Couldn't find text: "+b)}return new Range.NormalizedRange(f)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a}(),Range.NormalizedRange=function(){function a(a){this.commonAncestor=a.commonAncestor,this.start=a.start,this.end=a.end}return a.prototype.normalize=function(a,b){return this},a.prototype.limit=function(a){var b,c,d,e,f,g;if(b=$.grep(this.textNodes(),function(b){return b.parentNode===a||$.contains(a,b.parentNode)}),!b.length)return null;for(this.start=b[0],this.end=b[b.length-1],d=$(this.start).parents(),g=$(this.end).parents(),e=0,f=g.length;e<f;e++)if(c=g[e],d.index(c)!==-1){this.commonAncestor=c;break}return this},a.prototype.serialize=function(a,b){var c,d,e;return d=function(c,d){var e,f,g,h,i,j,k,l;for(h=b?$(c).parents(":not("+b+")").eq(0):$(c).parent(),j=Util.xpathFromNode(h,a)[0],i=Util.getTextNodes(h),f=i.slice(0,i.index(c)),g=0,k=0,l=f.length;k<l;k++)e=f[k],g+=e.nodeValue.length;return d?[j,g+c.nodeValue.length]:[j,g]},e=d(this.start),c=d(this.end,!0),new Range.SerializedRange({start:e[0],end:c[0],startOffset:e[1],endOffset:c[1]})},a.prototype.text=function(){var a;return function(){var b,c,d,e;for(d=this.textNodes(),e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(a.nodeValue);return e}.call(this).join("")},a.prototype.textNodes=function(){var a,b,c,d;return c=Util.getTextNodes($(this.commonAncestor)),d=[c.index(this.start),c.index(this.end)],b=d[0],a=d[1],$.makeArray(c.slice(b,+a+1||9e9))},a.prototype.toRange=function(){var a;return a=document.createRange(),a.setStartBefore(this.start),a.setEndAfter(this.end),a},a}(),Range.SerializedRange=function(){function a(a){this.start=a.start,this.startOffset=a.startOffset,this.end=a.end,this.endOffset=a.endOffset}return a.prototype.normalize=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;for(j={},f={start:null,end:null},b&&(l=$.map(b.split("\n"),function(a,b){var c;return c=a.trim(),c.length?c:null}),f.start=$(l).first()[0].toLowerCase(),f.end=$(l).last()[0].toLowerCase()),r=["start","end"],n=0,p=r.length;n<p;n++){i=r[n];try{h=Range.nodeFromXPath(this[i],a,f[i],this[i+"Offset"],i)}catch(t){throw d=t,new Range.RangeError(i,"Error while finding "+i+" node: "+this[i]+": "+d,d)}if(!h)throw new Range.RangeError(i,"Couldn't find "+i+" node: "+this[i]);for(g=$(h).data(i+"Offset"),$.isNumeric(g)&&(this[i+"Offset"]=g),
e=0,k=this[i+"Offset"],"end"===i&&k--,s=Util.getTextNodes($(h)),o=0,q=s.length;o<q;o++){if(m=s[o],e+m.nodeValue.length>k){j[i+"Container"]=m,j[i+"Offset"]=this[i+"Offset"]-e;break}e+=m.nodeValue.length}if(null==j[i+"Offset"])throw new Range.RangeError(""+i+"offset","Couldn't find offset "+this[i+"Offset"]+" in element "+this[i])}return c=null==document.compareDocumentPosition?function(a,b){return a.contains(b)}:function(a,b){return 16&a.compareDocumentPosition(b)},$(j.startContainer).parents().each(function(){if(c(this,j.endContainer))return j.commonAncestorContainer=this,!1}),new Range.BrowserRange(j).normalize(a,b)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},a}();var Annotator,g,_Annotator,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};jQuery.fn.addBack||(jQuery.fn.addBack=jQuery.fn.andSelf),_Annotator=this.Annotator,Annotator=function(a){function b(a,c){return this.onDeleteAnnotation=__bind(this.onDeleteAnnotation,this),this.onEditAnnotation=__bind(this.onEditAnnotation,this),this.onAdderClick=__bind(this.onAdderClick,this),this.onAdderMousedown=__bind(this.onAdderMousedown,this),this.onHighlightMouseover=__bind(this.onHighlightMouseover,this),this.checkForEndSelection=__bind(this.checkForEndSelection,this),this.checkForStartSelection=__bind(this.checkForStartSelection,this),this.checkForErrors=__bind(this.checkForErrors,this),this.clearViewerHideTimer=__bind(this.clearViewerHideTimer,this),this.startViewerHideTimer=__bind(this.startViewerHideTimer,this),this.showViewer=__bind(this.showViewer,this),this.onEditorSubmit=__bind(this.onEditorSubmit,this),this.onEditorHide=__bind(this.onEditorHide,this),this.showEditor=__bind(this.showEditor,this),b.__super__.constructor.apply(this,arguments),this.plugins={},b.supported()?(this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=$(this.html.adder).appendTo(this.wrapper).hide(),this.adderWarning=$(this.html.adderWarning).appendTo(this.wrapper).hide(),void b._instances.push(this)):this}return __extends(b,a),b.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},b.prototype.html={adder:'<div class="annotator-adder"><button>'+_t("Annotate")+"</button></div>",adderWarning:'<div class="annotator-adder-warning"></div>',wrapper:'<div class="annotator-wrapper"></div>'},b.prototype.options={readOnly:!1,exactMatch:!1,noDuplicates:!1,authenticator:"",minWords:0},b.prototype.plugins={},b.prototype.editor=null,b.prototype.viewer=null,b.prototype.selectedRanges=null,b.prototype.mouseIsDown=!1,b.prototype.ignoreMouseup=!1,b.prototype.viewerHideTimer=null,b.prototype._setupWrapper=function(){return this.wrapper=$(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},b.prototype._setupViewer=function(){var a=this;return this.viewer=new b.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(b,c){return c.text?$(b).html(Util.escape(c.text)):$(b).html("<i>"+_t("No Comment")+"</i>"),a.publish("annotationViewerTextField",[b,c])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},b.prototype._setupEditor=function(){return this.editor=new b.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:_t("Comments")+"â€¦",load:function(a,b){return $(a).find("textarea").val(b.text||"")},submit:function(a,b){return b.text=$(a).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},b.prototype._setupDocumentEvents=function(){return $(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},b.prototype._setupDynamicStyle=function(){var a,b,c,d;return c=$("#annotator-dynamic-style"),c.length||(c=$('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),b="*"+function(){var a,b,c,e;for(c=["adder","outer","notice","filter"],e=[],a=0,b=c.length;a<b;a++)d=c[a],e.push(":not(.annotator-"+d+")");return e}().join(""),a=Util.maxZIndex($(document.body).find(b)),a=Math.max(a,1e3),c.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(a+20)+";","}",".annotator-filter {","  z-index: "+(a+10)+";","}"].join("\n")),this},b.prototype.destroy=function(){var a,c,d,e;$(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),$("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return $(this).contents().insertBefore(this),$(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),e=this.plugins;for(c in e)d=e[c],this.plugins[c].destroy();if(this.removeEvents(),a=b._instances.indexOf(this),a!==-1)return b._instances.splice(a,1)},b.prototype.getSelectedRanges=function(){var a,b,c,d,e,f,g,h,i;for(g=Util.getGlobal().getSelection(),e=[],f=[],g.isCollapsed||(e=function(){var e,h,i;for(i=[],b=e=0,h=g.rangeCount;0<=h?e<h:e>h;b=0<=h?++e:--e)d=g.getRangeAt(b),a=new Range.BrowserRange(d),c=a.normalize().limit(this.wrapper[0]),null===c&&f.push(d),i.push(c);return i}.call(this),g.removeAllRanges()),h=0,i=f.length;h<i;h++)d=f[h],g.addRange(d);return $.grep(e,function(a){return a&&g.addRange(a.toRange()),a})},b.prototype.createAnnotation=function(){var a;return a={},this.publish("beforeAnnotationCreated",[a]),a},b.prototype.setupAnnotation=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;for(h=this.wrapper[0],d=!1,this.options.exactMatch&&a.quote&&(d=a.quote.toLowerCase().replace(/\xA0/g," ")),a.ranges||(a.ranges=this.selectedRanges),f=[],c=null,m=a.ranges,i=0,k=m.length;i<k;i++){g=m[i];try{f.push(Range.sniff(g).normalize(h,d))}catch(n){if(c=n,!(c instanceof Range.RangeError))throw c;this.publish("rangeNormalizeFail",[a,g,c])}}if(!c){for(a.quote=[],a.ranges=[],a.highlights=[],j=0,l=f.length;j<l;j++)e=f[j],a.quote.push($.trim(e.text())),a.ranges.push(e.serialize(this.wrapper[0],".annotator-hl")),b="annotator-hl",a.deleted&&(b+=" annotator-hl-deleted"),$.merge(a.highlights,this.highlightRange(e,b));a.quote=a.quote.join(" / ")}return $(a.highlights).data("annotation",a),a},b.prototype.updateAnnotation=function(a){return this.publish("beforeAnnotationUpdated",[a]),this.publish("annotationUpdated",[a]),a},b.prototype.deleteAnnotation=function(a,b){var c,d,e,f,g;if(null==b&&(b=!0),null!=a.highlights)for(g=a.highlights,e=0,f=g.length;e<f;e++)d=g[e],null!=d.parentNode&&(c=d.childNodes[0],$(d).replaceWith(d.childNodes));return b&&this.publish("annotationDeleted",[a]),a},b.prototype.loadAnnotations=function(a){var b,c,d=this;return null==a&&(a=[]),c=function(a){var e,f,g,h;for(null==a&&(a=[]),f=a.splice(0,10),g=0,h=f.length;g<h;g++)e=f[g],d.setupAnnotation(e);return a.length>0?setTimeout(function(){return c(a)},10):(d.publish("annotationsLoaded",[b]),d.publish("afterAnnotationsLoaded",[b]))},b=a.slice(),a.length?c(a):this.publish("afterAnnotationsLoaded",[]),this},b.prototype.refreshAnnotations=function(a){var b,c,d,e,f;if(null==a&&(a=[]),c=this.plugins.Store){for(f=[],d=0,e=a.length;d<e;d++)b=a[d],f.push(this.refreshAnnotation(b));return f}return console.warn(_t("Can't refresh annotations without Store plugin.")),!1},b.prototype.refreshAnnotation=function(a){var b,c,d,e,f,g,h;if(e=this.plugins.Store){for(c=a.id,b=a.deleted,h=e.annotations,f=0,g=h.length;f<g;f++)if(d=h[f],d.id===c)return b!==d.deleted?(this.deleteAnnotation(d,!1),e.updateAnnotation(d,a),this.publish("afterAnnotationDeleted",[d])):(e.updateAnnotation(d,a),this.publish("afterAnnotationUpdated",[d]));return a=this.setupAnnotation(a),e.registerAnnotation(a),e.updateAnnotation(a,{}),e.publish("afterAnnotationCreated",[a])}return console.warn(_t("Can't refresh annotations without Store plugin.")),!1},b.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(_t("Can't dump annotations without Store plugin.")),!1)},b.prototype.highlightRange=function(a,b){var c,d,e,f,g,h,i;for(null==b&&(b="annotator-hl"),e=/^\s*$/,c=$("<span class='"+b+"'></span>"),h=a.textNodes(),i=[],f=0,g=h.length;f<g;f++)d=h[f],e.test(d.nodeValue)||$(d).parents("textarea,input").length||i.push($(d).wrapAll(c).parent().show()[0]);return i},b.prototype.highlightRanges=function(a,b){var c,d,e,f;for(null==b&&(b="annotator-hl"),c=[],e=0,f=a.length;e<f;e++)d=a[e],$.merge(c,this.highlightRange(d,b));return c},b.prototype.addPlugin=function(a,c){var d,e;return this.plugins[a]?console.error(_t("You cannot have more than one instance of any plugin.")):(d=b.Plugin[a],"function"==typeof d?(this.plugins[a]=new d(this.element[0],c),this.plugins[a].annotator=this,"function"==typeof(e=this.plugins[a]).pluginInit&&e.pluginInit()):console.error(_t("Could not load ")+a+_t(" plugin. Have you included the appropriate <script> tag?"))),this},b.prototype.addField=function(a){return this.viewer.addField(a),this},b.prototype.showEditor=function(a,b){var c,d,e;return c=$(a.highlights),d=c.position(),e=d?d.top:b.top,e!==b.top&&(b.top=e),this.editor.element.css(b),this.editor.load(a),this.publish("annotationEditorShown",[this.editor,a]),this},b.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},b.prototype.onEditorSubmit=function(a){return this.publish("annotationEditorSubmit",[this.editor,a])},b.prototype.showViewer=function(a,b){var c;return!this.editor.isShown()&&(this.viewer.element.css(b),c=$.grep(a,function(a,b){return!a.deleted}),this.viewer.load(c),this.publish("annotationViewerShown",[this.viewer,c]))},b.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,250)},b.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},b.prototype.checkForErrors=function(a){var b,c,d,e,f,g,h;return f=$.trim(this.selectedRanges[0].text()),h=f.replace(/(?:\r\n|\r|\n)/g," ").split(" "),c=this.options.minWords,h.length<c?"Select at least "+c+" words to add a comment.":(d=this.options.noDuplicates)?(g=this.wrapper.text(),e=RegExp(f,"gim"),b=g.match(e),b&&b.length>1?"Multiple occurrences of selection ("+b.length+"). Refine it to add a comment.":void 0):void 0},b.prototype.checkForStartSelection=function(a){return a&&this.isAnnotator(a.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},b.prototype.checkForEndSelection=function(a){var b,c,d,e,f,g;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),g=this.selectedRanges,e=0,f=g.length;e<f;e++)if(d=g[e],b=d.commonAncestor,$(b).hasClass("annotator-hl")&&(b=$(b).parents("[class!=annotator-hl]")[0]),this.isAnnotator(b))return;return a&&this.selectedRanges.length?(c=this.checkForErrors(a),c?(this.adder.hide(),this.adderWarning.text(c).css(Util.mousePosition(a,this.wrapper[0])).fadeIn().delay(2e3).fadeOut()):this.adder.css(Util.mousePosition(a,this.wrapper[0])).show()):this.adder.hide()}},b.prototype.isAnnotator=function(a){return!!$(a).parents().addBack().filter("[class^=annotator-]").not(this.wrapper).length},b.prototype.onHighlightMouseover=function(a){var b,c,d,e,f,g;for(this.clearViewerHideTimer(),$(".annotator-hl").removeClass("hover"),b=$(a.target).data("annotation"),e=b?b.highlights:[],f=0,g=e.length;f<g;f++)d=e[f],$(d).addClass("hover");return!this.mouseIsDown&&!this.viewer.isShown()&&(c=$(a.target).parents(".annotator-hl").addBack().map(function(){return $(this).data("annotation")}),this.showViewer($.makeArray(c),Util.mousePosition(a,this.wrapper[0])))},b.prototype.onAdderMousedown=function(a){return null!=a&&a.preventDefault(),this.ignoreMouseup=!0},b.prototype.onAdderClick=function(a){var b,c,d,e,f,g=this;return null!=a&&a.preventDefault(),e=this.adder.position(),this.adder.hide(),b=this.setupAnnotation(this.createAnnotation()),$(b.highlights).addClass("annotator-hl-temporary"),f=function(){return d(),$(b.highlights).removeClass("annotator-hl-temporary"),g.publish("annotationCreated",[b])},c=function(){return d(),g.deleteAnnotation(b)},d=function(){return g.unsubscribe("annotationEditorHidden",c),g.unsubscribe("annotationEditorSubmit",f)},this.subscribe("annotationEditorHidden",c),this.subscribe("annotationEditorSubmit",f),this.showEditor(b,e)},b.prototype.onEditAnnotation=function(a){var b,c,d,e=this;return c=this.viewer.element.position(),d=function(){return b(),e.updateAnnotation(a)},b=function(){return e.unsubscribe("annotationEditorHidden",b),e.unsubscribe("annotationEditorSubmit",d)},this.subscribe("annotationEditorHidden",b),this.subscribe("annotationEditorSubmit",d),this.viewer.hide(),this.showEditor(a,c)},b.prototype.onDeleteAnnotation=function(a){return this.viewer.hide(),this.deleteAnnotation(a)},b}(Delegator),Annotator.Plugin=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.pluginInit=function(){},b.prototype.destroy=function(){return this.removeEvents()},b}(Delegator),g=Util.getGlobal(),null==(null!=(_ref=g.document)?_ref.evaluate:void 0)&&$.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==g.getSelection&&$.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==g.JSON&&$.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==g.Node&&(g.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),Annotator.$=$,Annotator.Delegator=Delegator,Annotator.Range=Range,Annotator.Util=Util,Annotator._instances=[],Annotator._t=_t,Annotator.supported=function(){return function(){return!!this.getSelection}()},Annotator.noConflict=function(){return Util.getGlobal().Annotator=_Annotator,this},$.fn.annotator=function(a){var b;return b=Array.prototype.slice.call(arguments,1),this.each(function(){var c;return c=$.data(this,"annotator"),c?a&&c[a].apply(c,b):(c=new Annotator(this,a),$.data(this,"annotator",c))})},this.Annotator=Annotator;var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Widget=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.classes=$.extend({},Annotator.Widget.prototype.classes,this.classes)}return __extends(b,a),b.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},b.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},b.prototype.checkOrientation=function(){var a,b,c,d,e;return this.resetOrientation(),e=$(Annotator.Util.getGlobal()),d=this.element.children(":first"),b=d.offset(),c={top:e.scrollTop(),right:e.width()+e.scrollLeft()},a={top:b.top,right:b.left+d.width()},a.top-c.top<0&&this.invertY(),a.right-c.right>0&&this.invertX(),this},b.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},b.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},b.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},b.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},b.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},b}(Delegator);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Editor=function(a){function b(a){this.onCancelButtonMouseover=__bind(this.onCancelButtonMouseover,this),this.processKeypress=__bind(this.processKeypress,this),this.submit=__bind(this.submit,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.html)[0],a),this.fields=[],this.annotation={}}return __extends(b,a),b.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},b.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},b.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+_t("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+_t("Save")+"</a>\n    </div>\n  </form>\n</div>",b.prototype.options={},b.prototype.show=function(a){return Annotator.Util.preventEventDefault(a),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},b.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},b.prototype.hide=function(a){return Annotator.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},b.prototype.load=function(a){var b,c,d,e;for(this.annotation=a,this.publish("load",[this.annotation]),e=this.fields,c=0,d=e.length;c<d;c++)b=e[c],b.load(b.element,this.annotation);return this.show()},b.prototype.submit=function(a){var b,c,d,e;for(Annotator.Util.preventEventDefault(a),e=this.fields,c=0,d=e.length;c<d;c++)b=e[c],b.submit(b.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},b.prototype.addField=function(a){var b,c,d;switch(c=$.extend({id:"annotator-field-"+Annotator.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},a),d=null,b=$('<li class="annotator-item" />'),c.element=b[0],c.type){case"textarea":d=$("<textarea />");break;case"input":case"checkbox":d=$("<input />");break;case"select":d=$("<select />")}return b.append(d),d.attr({id:c.id,placeholder:c.label}),"checkbox"===c.type&&(d[0].type="checkbox",b.addClass("annotator-checkbox"),b.append($("<label />",{"for":c.id,html:c.label}))),this.element.find("ul:first").append(b),this.fields.push(c),c.element},b.prototype.checkOrientation=function(){var a,c;return b.__super__.checkOrientation.apply(this,arguments),c=this.element.find("ul"),a=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?a.insertBefore(c):a.is(":first-child")&&a.insertAfter(c),this},b.prototype.processKeypress=function(a){return 27===a.keyCode?this.hide():13!==a.keyCode||a.shiftKey?void 0:this.submit()},b.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},b.prototype.setupDraggables=function(){var a,b,c,d,e,f,g,h,i,j,k;return this.element.find(".annotator-resize").remove(),c=this.element.hasClass(this.classes.invert.y)?this.element.find(".annotator-item:last"):this.element.find(".annotator-item:first"),c&&$('<span class="annotator-resize"></span>').appendTo(c),e=null,a=this.classes,d=this.element,j=null,i=d.find(".annotator-resize"),b=d.find(".annotator-controls"),k=!1,f=function(a){if(a.target===this)return e={element:this,top:a.pageY,left:a.pageX},j=d.find("textarea:first"),$(window).bind({"mouseup.annotator-editor-resize":h,"mousemove.annotator-editor-resize":g}),a.preventDefault()},h=function(){return e=null,$(window).unbind(".annotator-editor-resize")},g=function(c){var f,g,h,l,m;if(e&&k===!1)return f={top:c.pageY-e.top,left:c.pageX-e.left},e.element===i[0]?(l=j.outerHeight(),m=j.outerWidth(),g=d.hasClass(a.invert.x)?-1:1,h=d.hasClass(a.invert.y)?1:-1,j.height(l+f.top*h),j.width(m+f.left*g),j.outerHeight()!==l&&(e.top=c.pageY),j.outerWidth()!==m&&(e.left=c.pageX)):e.element===b[0]&&(d.css({top:parseInt(d.css("top"),10)+f.top,left:parseInt(d.css("left"),10)+f.left}),e.top=c.pageY,e.left=c.pageX),k=!0,setTimeout(function(){return k=!1},1e3/60)},i.unbind("mousedown"),b.unbind("mousedown"),i.bind("mousedown",f),b.bind("mousedown",f)},b}(Annotator.Widget);var LinkParser,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Viewer=function(a){function b(a){this.onDeleteClick=__bind(this.onDeleteClick,this),this.onEditClick=__bind(this.onEditClick,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.html.element)[0],a),this.item=$(this.html.item)[0],this.fields=[],this.annotations=[]}return __extends(b,a),b.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},b.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},b.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n      <button class="annotator-edit" title="Edit">\n        <span class="eea-icon eea-icon-edit"></span>\n      </button>\n      <button class="annotator-delete" title="Close">\n        <span class="eea-icon eea-icon-square-o"></span>\n      </button>\n  </span>\n</li>'},b.prototype.options={readOnly:!1},b.prototype.show=function(a){var b,c=this;if(Annotator.Util.preventEventDefault(a),this.annotations.length)return b=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(){return b.removeClass(c.classes.showControls)},500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},b.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},b.prototype.hide=function(a){return $(".annotator-hl").removeClass("hover"),Annotator.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},b.prototype.load=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(this.annotations=a||[],l=this.element.find("ul:first").empty(),q=this.annotations,m=0,o=q.length;m<o;m++)for(b=q[m],i=$(this.item).clone().appendTo(l).data("annotation",b),d=i.find(".annotator-controls"),j=d.find(".annotator-link"),f=d.find(".annotator-edit"),e=d.find(".annotator-delete"),k=new LinkParser(b.links||[]).get("alternate",{type:"text/html"}),0===k.length||null==k[0].href?j.remove():j.attr("href",k[0].href),this.options.readOnly?(f.remove(),e.remove()):c={showEdit:function(){return f.removeAttr("disabled")},hideEdit:function(){return f.attr("disabled","disabled")},showDelete:function(){return e.removeAttr("disabled")},hideDelete:function(){return e.attr("disabled","disabled")}},r=this.fields,n=0,p=r.length;n<p;n++)h=r[n],g=$(h.element).clone().appendTo(i)[0],h.load(g,b,c);return this.publish("load",[this.annotations]),this.show()},b.prototype.addField=function(a){var b;return b=$.extend({load:function(){}},a),b.element=$("<div />")[0],this.fields.push(b),b.element,this},b.prototype.onEditClick=function(a){return this.onButtonClick(a,"edit")},b.prototype.onDeleteClick=function(a){return this.onButtonClick(a,"delete")},b.prototype.onButtonClick=function(a,b){var c;return c=$(a.target).parents(".annotator-annotation"),this.publish(b,[c.data("annotation")])},b}(Annotator.Widget),LinkParser=function(){function a(a){this.data=a}return a.prototype.get=function(a,b){var c,d,e,f,g,h,i,j,k;for(null==b&&(b={}),b=$.extend({},b,{rel:a}),e=function(){var a;a=[];for(d in b)__hasProp.call(b,d)&&(g=b[d],a.push(d));return a}(),j=this.data,k=[],h=0,i=j.length;h<i;h++)c=j[h],f=e.reduce(function(a,d){return a&&c[d]===b[d]},!0),f&&k.push(c);return k},a}();var Annotator,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator=Annotator||{},Annotator.Notification=function(a){function b(a){this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.options.html).appendTo(document.body)[0],a)}return __extends(b,a),b.prototype.events={click:"hide"},b.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},b.prototype.show=function(a,b){return null==b&&(b=Annotator.Notification.INFO),$(this.element).addClass(this.options.classes.show).addClass(this.options.classes[b]).html(Util.escape(a||"")),setTimeout(this.hide,5e3),this},b.prototype.hide=function(){return $(this.element).removeClass(this.options.classes.show),this},b}(Delegator),Annotator.Notification.INFO="show",Annotator.Notification.SUCCESS="success",Annotator.Notification.ERROR="error",$(function(){var a;return a=new Annotator.Notification,Annotator.showNotification=a.show,Annotator.hideNotification=a.hide});var _ref,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Unsupported=function(a){function b(){return _ref=b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={message:Annotator._t("Sorry your current browser does not support the Annotator")},b.prototype.pluginInit=function(){var a=this;if(!Annotator.supported())return $(function(){if(Annotator.showNotification(a.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject)return $("html").addClass("ie6")})},b}(Annotator.Plugin);var base64Decode,base64UrlDecode,createDateFromISO8601,parseToken,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};createDateFromISO8601=function(a){var b,c,d,e,f,g;return e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",b=a.match(new RegExp(e)),d=0,c=new Date(b[1],0,1),b[3]&&c.setMonth(b[3]-1),b[5]&&c.setDate(b[5]),b[7]&&c.setHours(b[7]),b[8]&&c.setMinutes(b[8]),b[10]&&c.setSeconds(b[10]),b[12]&&c.setMilliseconds(1e3*Number("0."+b[12])),b[14]&&(d=60*Number(b[16])+Number(b[17]),d*=null!=(g="-"===b[15])?g:{1:-1}),d-=c.getTimezoneOffset(),f=Number(c)+60*d*1e3,c.setTime(Number(f)),c},base64Decode=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;if("undefined"!=typeof atob&&null!==atob)return atob(a);if(c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",j=0,b=0,e="",n=[],!a)return a;for(a+="";j<a.length;)f=c.indexOf(a.charAt(j++)),g=c.indexOf(a.charAt(j++)),h=c.indexOf(a.charAt(j++)),i=c.indexOf(a.charAt(j++)),d=f<<18|g<<12|h<<6|i,k=d>>16&255,l=d>>8&255,m=255&d,64===h?n[b++]=String.fromCharCode(k):64===i?n[b++]=String.fromCharCode(k,l):n[b++]=String.fromCharCode(k,l,m);return n.join("")},base64UrlDecode=function(a){var b,c,d,e;if(c=a.length%4,0!==c)for(b=d=0,e=4-c;0<=e?d<e:d>e;b=0<=e?++d:--d)a+="=";return a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),base64Decode(a)},parseToken=function(a){var b,c,d,e;return e=a.split("."),b=e[0],c=e[1],d=e[2],JSON.parse(base64UrlDecode(c))},Annotator.Plugin.Auth=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return __extends(b,a),b.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},b.prototype.requestToken=function(){var a=this;return this.requestInProgress=!0,$.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(b,c,d){return a.setToken(b)}).fail(function(a,b,c){var d;return d=Annotator._t("Couldn't get auth token:"),console.error(""+d+" "+c,a),Annotator.showNotification(""+d+" "+a.responseText,Annotator.Notification.ERROR)}).always(function(){return a.requestInProgress=!1})},b.prototype.setToken=function(a){var b,c=this;if(this.token=a,this._unsafeToken=parseToken(a),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(){return c.requestToken()},1e3*(this.timeToExpiry()-2))),this.updateHeaders(),b=[];this.waitingForToken.length>0;)b.push(this.waitingForToken.pop()(this._unsafeToken));return b}if(console.warn(Annotator._t("Didn't get a valid token.")),this.options.autoFetch)return console.warn(Annotator._t("Getting a new token in 10s.")),setTimeout(function(){return c.requestToken()},1e4)},b.prototype.haveValidToken=function(){var a;return a=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,!!(a&&this.timeToExpiry()>0)},b.prototype.timeToExpiry=function(){var a,b,c,d;return c=(new Date).getTime()/1e3,b=createDateFromISO8601(this._unsafeToken.issuedAt).getTime()/1e3,a=b+this._unsafeToken.ttl,d=a-c,d>0?d:0},b.prototype.updateHeaders=function(){var a;return a=this.element.data("annotator:headers"),this.element.data("annotator:headers",$.extend(a,{"x-annotator-auth-token":this.token}))},b.prototype.withToken=function(a){if(null!=a)return this.haveValidToken()?a(this._unsafeToken):(this.waitingForToken.push(a),this.requestInProgress?void 0:this.requestToken())},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.Store=function(a){function b(a,c){this._onError=__bind(this._onError,this),this._onLoadAnnotationsFromSearch=__bind(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=__bind(this._onLoadAnnotations,this),this._getAnnotations=__bind(this._getAnnotations,this),b.__super__.constructor.apply(this,arguments),this.annotations=[]}return __extends(b,a),b.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},b.prototype.options={annotationData:{},history:!1,emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},b.prototype.pluginInit=function(){if(Annotator.supported())return this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations()},b.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations();
},b.prototype.annotationCreated=function(a){var b=this;return __indexOf.call(this.annotations,a)<0?(this.registerAnnotation(a),this._apiRequest("create",a,function(c){return null==c.id&&console.warn(Annotator._t("Warning: No ID returned from server for annotation "),a),b.updateAnnotation(a,c),b.annotator.publish("afterAnnotationCreated",[a])})):this.updateAnnotation(a,{})},b.prototype.annotationUpdated=function(a){var b=this;if(__indexOf.call(this.annotations,a)>=0)return this._apiRequest("update",a,function(c){return b.updateAnnotation(a,c),b.annotator.publish("afterAnnotationUpdated",[a])})},b.prototype.annotationDeleted=function(a){var b=this;return this.options.history&&(a.deleted?a.deleted=!1:a.deleted=!0),this._apiRequest("destroy",a,function(c){return c&&b.updateAnnotation(a,c),b.options.history||b.unregisterAnnotation(a),b.annotator.publish("afterAnnotationDeleted",[a])})},b.prototype.registerAnnotation=function(a){return this.annotations.push(a)},b.prototype.unregisterAnnotation=function(a){return this.annotations.splice(this.annotations.indexOf(a),1)},b.prototype.updateAnnotation=function(a,b){var c,d,e,f,g;for(c=!1,g=this.annotations,e=0,f=g.length;e<f;e++)if(d=g[e],d.id===a.id){$.extend(d,a),$.extend(a,b),c=!0;break}return c||console.error(Annotator._t("Trying to update unregistered annotation!")),$(a.highlights).data("annotation",a)},b.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},b.prototype._onLoadAnnotations=function(a){var b,c,d,e,f,g,h,i,j;for(null==a&&(a=[]),d={},j=this.annotations,f=0,h=j.length;f<h;f++)b=j[f],d[b.id]=b;for(e=[],g=0,i=a.length;g<i;g++)b=a[g],d[b.id]?(c=d[b.id],this.updateAnnotation(c,b)):e.push(b);return this.annotations=this.annotations.concat(e),this.annotator.loadAnnotations(e.slice())},b.prototype.loadAnnotationsFromSearch=function(a){return this._apiRequest("search",a,this._onLoadAnnotationsFromSearch)},b.prototype._onLoadAnnotationsFromSearch=function(a){return null==a&&(a={}),this._onLoadAnnotations(a.rows||[])},b.prototype.dumpAnnotations=function(){var a,b,c,d,e;for(d=this.annotations,e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(JSON.parse(this._dataFor(a)));return e},b.prototype._apiRequest=function(a,b,c){var d,e,f,g;return d=b&&b.id,g=this._urlFor(a,d),e=this._apiRequestOptions(a,b,c),f=$.ajax(g,e),f._id=d,f._action=a,f},b.prototype._apiRequestOptions=function(a,b,c){var d,e,f,g;return f=this._methodFor(a),g={type:f,headers:this.element.data("annotator:headers"),dataType:"json",success:c||function(){},error:this._onError},d=this.annotator.options.authenticator,d&&(g.headers=$.extend(g.headers,{"X-CSRF-TOKEN":d})),!this.options.emulateHTTP||"PUT"!==f&&"DELETE"!==f||(g.headers=$.extend(g.headers,{"X-HTTP-Method-Override":f}),g.type="POST"),"search"===a?g=$.extend(g,{data:b}):(e=b&&this._dataFor(b),this.options.emulateJSON?(g.data={json:e},this.options.emulateHTTP&&(g.data._method=f),g):g=$.extend(g,{data:e,contentType:"application/json; charset=utf-8"}))},b.prototype._urlFor=function(a,b){var c;return c=null!=this.options.prefix?this.options.prefix:"",c+=this.options.urls[a],c=c.replace(/\/:id/,null!=b?"/"+b:""),c=c.replace(/:id/,null!=b?b:"")},b.prototype._methodFor=function(a){var b;return b={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},b[a]},b.prototype._dataFor=function(a){var b,c;return c=a.highlights,delete a.highlights,$.extend(a,this.options.annotationData),b=JSON.stringify(a),c&&(a.highlights=c),b},b.prototype._onError=function(a){var b,c;switch(b=a._action,c=Annotator._t("Sorry we could not ")+b+Annotator._t(" this annotation"),"search"===a._action?c=Annotator._t("Sorry we could not search the store for annotations"):"read"!==a._action||a._id||(c=Annotator._t("Sorry we could not ")+b+Annotator._t(" the annotations from the store")),a.status){case 401:c=Annotator._t("Sorry you are not allowed to ")+b+Annotator._t(" this annotation");break;case 404:c=Annotator._t("Sorry we could not connect to the annotations store");break;case 500:c=Annotator._t("Sorry something went wrong with the annotation store")}return Annotator.showNotification(c,Annotator.Notification.ERROR),console.error(Annotator._t("API request failed:")+(" '"+a.status+"'"))},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Permissions=function(a){function b(a,c){this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateReplyControls=__bind(this.updateReplyControls,this),this.updateViewer=__bind(this.updateViewer,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),b.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return __extends(b,a),b.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation",replyLoaded:"updateReplyControls"},b.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(a){return a},userString:function(a){return a},userAuthorize:function(a,b,c){var d,e,f,g;if(b.permissions){if(e=b.permissions[a]||[],0===e.length)return!0;for(f=0,g=e.length;f<g;f++)if(d=e[f],this.userId(c)===d)return!0;return!1}return!b.user||!!c&&this.userId(c)===this.userId(b.user)},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}},b.prototype.pluginInit=function(){var a,b,c=this;if(Annotator.supported())return b=this,a=function(a,c){return function(d,e){return b[a].call(b,c,d,e)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),this.options.showViewPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>view</strong> this annotation"),load:a("updatePermissionsField","read"),submit:a("updateAnnotationPermissions","read")}),this.options.showEditPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>edit</strong> this annotation"),load:a("updatePermissionsField","update"),submit:a("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:Annotator._t("User"),property:"user",isFiltered:function(a,b){var d,e,f,g;if(b=c.options.userString(b),!a||!b)return!1;for(g=a.split(/\s*/),e=0,f=g.length;e<f;e++)if(d=g[e],b.indexOf(d)===-1)return!1;return!0}}):void 0},b.prototype.setUser=function(a){return this.user=a},b.prototype.addFieldsToAnnotation=function(a){if(a&&(a.permissions=this.options.permissions,this.user))return a.user=this.user},b.prototype.authorize=function(a,b,c){return void 0===c&&(c=this.user),!this.options.userAuthorize||this.options.userAuthorize.call(this.options,a,b,c)},b.prototype.updatePermissionsField=function(a,b,c){var d;return b=$(b).show(),d=b.find("input").removeAttr("disabled"),this.authorize("admin",c)||b.hide(),this.authorize(a,c||{},null)?d.attr("checked","checked"):d.removeAttr("checked")},b.prototype.updateAnnotationPermissions=function(a,b,c){var d;return c.permissions||(c.permissions=this.options.permissions),d=a+"-permissions",$(b).find("input").is(":checked")?c.permissions[a]=[]:c.permissions[a]=[this.options.userId(this.user)]},b.prototype.updateViewer=function(a,b,c){var d,e,f;if(a=$(a),e=this.options.userString(b.user),f=Util.userTitle(b.user),b.user&&e&&"string"==typeof e?(d=Annotator.Util.escape(this.options.userString(b.user)),a.html(d).addClass("annotator-user").attr("title",f)):a.remove(),c&&(this.authorize("update",b)||c.hideEdit(),!this.authorize("delete",b)))return c.hideDelete()},b.prototype.updateReplyControls=function(a){var b,c,d;if(d=a.user,c=this.element.find(".reply"),b=c.find(".annotator-delete-reply"),b&&this.options.userString(this.user)!==this.options.userString(d))return b.attr("disabled","disabled")},b.prototype._setAuthFromToken=function(a){return this.setUser(a.userId)},b}(Annotator.Plugin);var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.AnnotateItPermissions=function(a){function b(){return this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),_ref=b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(a){return a.userId},userString:function(a){return a.userId},userAuthorize:function(a,b,c){var d,e,f,g,h,i;return e=b.permissions||{},d=e[a]||[],f=this.groups.world,__indexOf.call(d,f)>=0||null!=c&&null!=c.userId&&null!=c.consumerKey&&(c.userId===b.user&&c.consumerKey===b.consumer||(g=this.groups.authenticated,__indexOf.call(d,g)>=0||(c.consumerKey===b.consumer&&(h=this.groups.consumer,__indexOf.call(d,h)>=0)||(c.consumerKey===b.consumer&&(i=c.userId,__indexOf.call(d,i)>=0)||!(c.consumerKey!==b.consumer||!c.admin)))))},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}},b.prototype.addFieldsToAnnotation=function(a){if(a&&(a.permissions=this.options.permissions,this.user))return a.user=this.user.userId,a.consumer=this.user.consumerKey},b.prototype.updatePermissionsField=function(a,b,c){var d;return b=$(b).show(),d=b.find("input").removeAttr("disabled"),this.authorize("admin",c)||b.hide(),this.user&&this.authorize(a,c||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?d.attr("checked","checked"):d.removeAttr("checked")},b.prototype.updateAnnotationPermissions=function(a,b,c){var d;return c.permissions||(c.permissions=this.options.permissions),d=a+"-permissions",$(b).find("input").is(":checked")?c.permissions[a]=["read"===a?this.options.groups.world:this.options.groups.consumer]:c.permissions[a]=[]},b.prototype._setAuthFromToken=function(a){return this.setUser(a)},b}(Annotator.Plugin.Permissions);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Filter=function(a){function b(a,c){this._onPreviousClick=__bind(this._onPreviousClick,this),this._onNextClick=__bind(this._onNextClick,this),this._onFilterKeyup=__bind(this._onFilterKeyup,this),this._onFilterBlur=__bind(this._onFilterBlur,this),this._onFilterFocus=__bind(this._onFilterFocus,this),this.updateHighlights=__bind(this.updateHighlights,this);var d;a=$(this.html.element).appendTo((null!=c?c.appendTo:void 0)||this.options.appendTo),b.__super__.constructor.call(this,a,c),(d=this.options).filters||(d.filters=[]),this.filter=$(this.html.filter),this.filters=[],this.current=0}return __extends(b,a),b.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},b.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},b.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"},b.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(a,b){var c,d,e,f;if(!a||!b)return!1;for(f=a.split(/\s+/),d=0,e=f.length;d<e;d++)if(c=f[d],b.indexOf(c)===-1)return!1;return!0}},b.prototype.pluginInit=function(){var a,b,c,d;for(d=this.options.filters,b=0,c=d.length;b<c;b++)a=d[b],this.addFilter(a);if(this.updateHighlights(),this._setupListeners()._insertSpacer(),this.options.addAnnotationFilter===!0)return this.addFilter({label:Annotator._t("Annotation"),property:"text"})},b.prototype.destroy=function(){var a,c;return b.__super__.destroy.apply(this,arguments),c=$("html"),a=parseInt(c.css("padding-top"),10)||0,c.css("padding-top",a-this.element.outerHeight()),this.element.remove()},b.prototype._insertSpacer=function(){var a,b;return b=$("html"),a=parseInt(b.css("padding-top"),10)||0,b.css("padding-top",a+this.element.outerHeight()),this},b.prototype._setupListeners=function(){var a,b,c,d;for(b=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],c=0,d=b.length;c<d;c++)a=b[c],this.annotator.subscribe(a,this.updateHighlights);return this},b.prototype.addFilter=function(a){var b,c;return c=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},a),function(){var a,d,e,f;for(e=this.filters,f=[],a=0,d=e.length;a<d;a++)b=e[a],b.property===c.property&&f.push(b);return f}.call(this).length||(c.id="annotator-filter-"+c.property,c.annotations=[],c.element=this.filter.clone().appendTo(this.element),c.element.find("label").html(c.label).attr("for",c.id),c.element.find("input").attr({id:c.id,placeholder:Annotator._t("Filter by ")+c.label+"â€¦"}),c.element.find("button").hide(),c.element.data("filter",c),this.filters.push(c)),this},b.prototype.updateFilter=function(a){var b,c,d,e,f,g,h;if(a.annotations=[],this.updateHighlights(),this.resetHighlights(),d=$.trim(a.element.find("input").val())){for(c=this.highlights.map(function(){return $(this).data("annotation")}),h=$.makeArray(c),f=0,g=h.length;f<g;f++)b=h[f],e=b[a.property],a.isFiltered(d,e)&&a.annotations.push(b);return this.filterHighlights()}},b.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},b.prototype.filterHighlights=function(){var a,b,c,d,e,f,g,h,i,j;for(a=$.grep(this.filters,function(a){return!!a.annotations.length}),d=(null!=(j=a[0])?j.annotations:void 0)||[],a.length>1&&(c=[],$.each(a,function(){return $.merge(c,this.annotations)}),g=[],d=[],$.each(c,function(){return $.inArray(this,g)===-1?g.push(this):d.push(this)})),e=this.highlights,f=h=0,i=d.length;h<i;f=++h)b=d[f],e=e.not(b.highlights);return e.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},b.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},b.prototype._onFilterFocus=function(a){var b;return b=$(a.target),b.parent().addClass(this.classes.active),b.next("button").show()},b.prototype._onFilterBlur=function(a){var b;if(!a.target.value)return b=$(a.target),b.parent().removeClass(this.classes.active),b.next("button").hide()},b.prototype._onFilterKeyup=function(a){var b;if(b=$(a.target).parent().data("filter"))return this.updateFilter(b)},b.prototype._findNextHighlight=function(a){var b,c,d,e,f,g,h,i;return this.highlights.length?(g=a?0:-1,i=a?-1:0,h=a?"lt":"gt",b=this.highlights.not("."+this.classes.hl.hide),d=b.filter("."+this.classes.hl.active),d.length||(d=b.eq(g)),c=d.data("annotation"),e=b.index(d[0]),f=b.filter(":"+h+"("+e+")").not(c.highlights).eq(i),f.length||(f=b.eq(i)),this._scrollToHighlight(f.data("annotation").highlights)):this},b.prototype._onNextClick=function(a){return this._findNextHighlight()},b.prototype._onPreviousClick=function(a){return this._findNextHighlight(!0)},b.prototype._scrollToHighlight=function(a){return a=$(a),this.highlights.removeClass(this.classes.hl.active),a.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:a.offset().top-(this.element.height()+20)},150)},b.prototype._onClearClick=function(a){return $(a.target).prev("input").val("").keyup().blur()},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Markdown=function(a){function b(a,c){this.updateTextField=__bind(this.updateTextField,this),null!=("undefined"!=typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(b.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(Annotator._t("To use the Markdown plugin, you must include Showdown into the page first."))}return __extends(b,a),b.prototype.events={annotationViewerTextField:"updateTextField"},b.prototype.updateTextField=function(a,b){var c;return c=Annotator.Util.escape(b.text||""),$(a).html(this.convert(c))},b.prototype.convert=function(a){return this.converter.makeHtml(a)},b}(Annotator.Plugin);var _ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Tags=function(a){function b(){return this.setAnnotationTags=__bind(this.setAnnotationTags,this),this.updateField=__bind(this.updateField,this),_ref=b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={parseTags:function(a){var b;return a=$.trim(a),b=[],a&&(b=a.split(/\s+/)),b},stringifyTags:function(a){return a.join(" ")}},b.prototype.field=null,b.prototype.input=null,b.prototype.pluginInit=function(){if(Annotator.supported())return this.field=this.annotator.editor.addField({label:Annotator._t("Add some tags here")+"â€¦",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:Annotator._t("Tag"),property:"tags",isFiltered:Annotator.Plugin.Tags.filterCallback}),this.input=$(this.field).find(":input")},b.prototype.parseTags=function(a){return this.options.parseTags(a)},b.prototype.stringifyTags=function(a){return this.options.stringifyTags(a)},b.prototype.updateField=function(a,b){var c;return c="",b.tags&&(c=this.stringifyTags(b.tags)),this.input.val(c)},b.prototype.setAnnotationTags=function(a,b){return b.tags=this.parseTags(this.input.val())},b.prototype.updateViewer=function(a,b){return a=$(a),b.tags&&$.isArray(b.tags)&&b.tags.length?a.addClass("annotator-tags").html(function(){var a;return a=$.map(b.tags,function(a){return'<span class="annotator-tag">'+Annotator.Util.escape(a)+"</span>"}).join(" ")}):a.remove()},b}(Annotator.Plugin),Annotator.Plugin.Tags.filterCallback=function(a,b){var c,d,e,f,g,h,i,j;if(null==b&&(b=[]),e=0,d=[],a)for(d=a.split(/\s+/g),g=0,i=d.length;g<i;g++)if(c=d[g],b.length)for(h=0,j=b.length;h<j;h++)f=b[h],f.indexOf(c)!==-1&&(e+=1);return e===d.length};var __hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.prototype.setupPlugins=function(a,b){var c,d,e,f,g,h,i,j,k;null==a&&(a={}),null==b&&(b={}),h=Annotator.Util.getGlobal(),f=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions"],h.Showdown&&f.push("Markdown"),g=h.location.href.split(/#|\?/).shift()||"",e={Tags:{},Filter:{filters:[{label:Annotator._t("User"),property:"user"},{label:Annotator._t("Tags"),property:"tags"}]},Auth:{tokenUrl:a.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:a.storeUrl||"http://annotateit.org/api",annotationData:{uri:g},loadFromSearch:{uri:g}}};for(c in b)__hasProp.call(b,c)&&(d=b[c],__indexOf.call(f,c)<0&&f.push(c));for($.extend(!0,e,b),k=[],i=0,j=f.length;i<j;i++)c=f[i],c in e&&!e[c]?k.push(void 0):k.push(this.addPlugin(c,e[c]));return k};var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Comment=function(a){function b(a){this.processKeypress=__bind(this.processKeypress,this),b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.events={annotationViewerShown:"addReplyButton",".annotator-reply-save click":"onReplyEntryClick",".annotator-cancel click":"hide",".replyentry keydown":"processKeypress",".replyentry click":"processKeypress",".annotator-delete-reply click":"deleteReply"},b.prototype.pluginInit=function(){!Annotator.supported()},b.prototype.addReplyButton=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;for(j=this.annotator.element.find(".annotator-annotation.annotator-item"),g=q=0,s=j.length;q<s;g=++q){if(i=j[g],i=$(i),l=b[g].replies||[],l.length>0&&i.append('<div class="annotator-replies"></div>'),l.length>0)for(n=this.annotator.element.find(".annotator-replies"),r=0,t=l.length;r<t;r++)m=l[r],p=Util.userTitle(m.user),o=Util.userString(m.user),h=m.updated||m.created,h.endsWith("Z")||(h+="Z"),k=new Date(h),e=Util.easyDate(k),f="<div class='reply'>",this.annotator.options.readOnly||m===l[l.length-1]&&(c="<span class='annotator-controls'>",c+="<button title=\"Delete\" class='annotator-delete-reply'>",c+="<span class='eea-icon eea-icon-times'></span>",c+="</button>",c+="</span>",f+=c),f+="<div class='replytext'>"+m.reply+"</div>\n<div class='annotator-date' title=\""+Util.prettyDateString(k)+'">'+e+"</div>\n<div class='annotator-user replyuser' title=\""+p+'">'+o+"</div>\n</div>",$(n[g]).append(f),d={user:m.user,replydiv:f,replies_no:l.length},this.publish("replyLoaded",d);this.annotator.options.readOnly||i.append('<div class=\'replybox\'><textarea class="replyentry" placeholder="Reply..."></textarea>')}return a.checkOrientation()},b.prototype.onReplyEntryClick=function(a){var b,c,d,e,f;if(a.preventDefault(),b=$(a.target).parent().parent(),f=b.find(".replyentry"),d=f.val(),""!==d)return e=this.getReplyObject(),e.reply=d,b=$(a.target).parents(".annotator-annotation"),c=b.data("annotation"),c.replies||(c.replies=[]),c.replies.push(e),c=this.annotator.updateAnnotation(c),this.annotator.viewer.hide()},b.prototype.deleteReply=function(a){var b,c,d,e,f,g,h,i;for(d=$(a.target).parents(".reply"),b=d.parents(".annotator-annotation").data("annotation"),g=d.find(".replytext")[0].innerHTML,e=b.replies||[],c=h=0,i=e.length;h<i;c=++h)f=e[c],g===f.reply&&(b.replies[c].remove=!0,d.slideUp(function(){return d.remove()}));return b=this.annotator.updateAnnotation(b)},b.prototype.getReplyObject=function(){var a;return a={reply:"",created:(new Date).toJSON()}},b.prototype.processKeypress=function(a){var b,c;return c=$(a.target).parent(),b=c.find(".annotator-reply-controls"),0===b.length&&(c.append('<div class="annotator-reply-controls">\n<a href="#save" class="annotator-reply-save">Save</a>\n<a href="#cancel" class="annotator-cancel">Cancel</a>\n</div>\n</div>'),this.annotator.viewer.checkOrientation()),27===a.keyCode?this.annotator.viewer.hide():13!==a.keyCode||a.shiftKey?void 0:this.onReplyEntryClick(a)},b.prototype.hide=function(a){return a.preventDefault(),this.annotator.viewer.hide()},b}(Annotator.Plugin);var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__bind=function(a,b){return function(){return a.apply(b,arguments)}};Annotator.Plugin.Errata=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.events={afterAnnotationsLoaded:"annotationsLoaded",afterAnnotationCreated:"annotationCreated",afterAnnotationDeleted:"annotationDeleted",afterAnnotationUpdated:"annotationUpdated",rangeNormalizeFail:"rangeNormalizeFail"},b.prototype.options={element:".annotator-errata"},b.prototype.pluginInit=function(){var a,b,c,d,e,f;if(Annotator.supported()){for(this.errata=[],this.elements=$(this.options.element),e=this.elements,f=[],c=0,d=e.length;c<d;c++)b=e[c],a=new Annotator.Erratum(b,{annotator:this.annotator}),f.push(this.errata.push(a));return f}},b.prototype.annotationsLoaded=function(a){var b,c,d,e,f;for(e=this.errata,f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(b.annotationsLoaded(a));return f},b.prototype.annotationCreated=function(a){var b,c,d,e,f;for(e=this.errata,f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(b.annotationCreated(a));return f},b.prototype.annotationDeleted=function(a){var b,c,d,e,f;for(e=this.errata,f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(b.annotationDeleted(a));return f},b.prototype.annotationUpdated=function(a){var b,c,d,e,f;for(e=this.errata,f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(b.annotationUpdated(a));return f},b.prototype.rangeNormalizeFail=function(a){var b,c,d,e,f;for(e=this.errata,f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(b.rangeNormalizeFail(a));return f},b}(Annotator.Plugin),Annotator.Erratum=function(a){function b(a,c){this.processKeypress=__bind(this.processKeypress,this),b.__super__.constructor.apply(this,arguments),this.annotator=this.options.annotator,this.readOnly=this.annotator.options.readOnly}return __extends(b,a),b.prototype.options={annotator:null},b.prototype.missing={},b.prototype._setupSections=function(){return this.element.empty(),this.element.addClass("eea-accordion-panels collapsed-by-default non-exclusive"),this.pendingCount=0,this.pending=$('<div class="annotator-erratum-section annotator-erratum-pending eea-accordion-panel">\n  <h2>Active comments (<span class="count">'+this.pendingCount+'</span>)<span class="eea-icon eea-icon-right"></span></h2>\n  <div class="pane"></div>\n</div>').appendTo(this.element),this.closedCount=0,this.closed=$('<div class="annotator-erratum-section annotator-erratum-closed eea-accordion-panel">\n  <h2>Closed comments (<span class="count">'+this.closedCount+'</span>)<span class="eea-icon eea-icon-right"></span></h2>\n  <div class="pane"></div>\n</div>').appendTo(this.element)},b.prototype._setupComment=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;for(null==b&&(b=!1),o=this,p=Util.escape(a.text),s=Util.userTitle(a.user),r=Util.userString(a.user),h=a.created,h.endsWith("Z")||(h+="Z"),j=new Date(h),d=Util.easyDate(j),e=$('<div class="annotator-erratum annotator-item" data-id="'+a.id+'">\n<span class="annotator-controls">\n  <button title="Close" class="annotator-delete">\n    <span class="eea-icon eea-icon-square-o"></span>\n  </button>\n</span>\n<div class="erratum-quote">\n  <span class="erratum-header-date" title="'+Util.prettyDateString(j)+'">'+d+'</span>\n<span class="erratum-header-user" title="'+s+'">'+r+'</span>\n<span class="erratum-header-text">'+p+'</span>\n</div>\n<dl class="erratum-comment">\n  <dt class="replyquote">'+a.quote+"</dt>\n  </dl>\n</div>"),e.find(".annotator-delete").click(function(b){return o.annotator.onDeleteAnnotation(a)}),f=e.find(".erratum-comment").hide(),l=a.replies||[],l.length&&$('<dt class="erratum-header-replies">Replies</dt>').appendTo(f),u=0,v=l.length;u<v;u++)m=l[u],p=Util.escape(m.reply),s=Util.userTitle(m.user),r=Util.userString(m.user),h=m.updated||m.created,h.endsWith("Z")||(h+="Z"),j=new Date(h),d=Util.easyDate(j),c=$('<dt class="replytext">'+p+'</dt>\n<dd class="annotator-date" title="'+Util.prettyDateString(j)+'">'+d+'</dd>\n<dd class="annotator-user" title="'+s+'">'+r+"</dd>"),c.appendTo(f);return i=this.missing[a.id],i&&(e.addClass("missing"),k=e.find(".erratum-comment"),k.attr("data-tooltip","Can't find the text the comment was referring to"),k.data("tooltip","Can't find the text the comment was referring to")),this.readOnly?e.find(".annotator-controls").remove():a.deleted||(n=$('<div class=\'replybox\'><textarea class="replyentry-errata" placeholder="Reply..."></textarea>'),n.appendTo(f),q=n.find(".replyentry-errata"),q.bind("click",function(b){return o.processKeypress(b,a)}),q.bind("keydown",function(b){return o.processKeypress(b,a)})),g=e.find(".eea-icon-square-o"),a.deleted?(t=this.closed.find(".pane"),g.removeClass("eea-icon-square-o").addClass("eea-icon-check-square-o").attr("title","Reopen"),g.bind({click:function(){return g.removeClass("eea-icon-check-square-o"),g.addClass("eea-icon-square-o")}})):(t=this.pending.find(".pane"),g.bind({click:function(){return g.removeClass("eea-icon-square-o"),g.addClass("eea-icon-check-square-o")}})),e.data("id",a.id).data("comment",a).hide().prependTo(t).slideDown(function(){return o._reloadComment(a,b),o._updateCounters()}),this},b.prototype.processKeypress=function(a,b){var c,d,e,f,g,h;return h=this,e=$(a.target).parent(),d=e.find(".annotator-reply-controls"),0===d.length&&(f=$('<div class="annotator-reply-controls">\n<a href="#save" class="annotator-reply-save">Save</a>\n<a href="#cancel" class="annotator-cancel">Cancel</a>\n</div>\n</div>'),e.append(f),g=f.find(".annotator-reply-save"),c=f.find(".annotator-cancel"),g&&g.bind("click",function(a){return a.preventDefault(),h.onReplyEntryClick(a,b)}),c&&c.bind("click",function(a){return a.preventDefault(),h.onCancelReply(a,b)})),13!==a.keyCode||a.shiftKey?27===a.keyCode?this.onCancelReply(a,b):void 0:this.onReplyEntryClick(a,b)},b.prototype.onReplyEntryClick=function(a,b){var c,d,e,f;if(a.preventDefault(),c=$(a.target).parent().parent(),f=c.find(".replyentry-errata"),d=f.val(),""!==d)return e=this.getReplyObject(),e.reply=d,b.replies||(b.replies=[]),b.replies.push(e),b=this.annotator.updateAnnotation(b)},b.prototype.onCancelReply=function(a,b){var c,d;return a.preventDefault(),c=$(a.target).parents(".erratum-comment"),d=c.find(".annotator-reply-controls"),d.parent().find(".replyentry-errata").val(""),d.remove()},b.prototype.getReplyObject=function(){var a;return a={reply:"",created:(new Date).toJSON()}},b.prototype._reloadComment=function(a,b){var c,d,e,f,g;return null==b&&(b=!1),g=this,c=this.element.find('[data-id="'+a.id+'"]'),f=c.parent(),e=f.data("openedAnnotation"),e===a.id&&(this.element.find(".erratum-comment").slideUp("fast"),this.element.find(".annotator-erratum").removeClass("open"),c.addClass("open"),c.find(".erratum-comment").slideDown("fast")),d=c.find(".erratum-quote"),d.unbind(),d.bind({click:function(b){var d,e;return d={annotation:a,element:c},g.publish("beforeClick",d),e=c.hasClass("open"),g.element.find(".erratum-comment").slideUp("fast"),g.element.find(".annotator-erratum").removeClass("open"),g.element.find(".erratum-comment").trigger("commentUnCollapsed",[d]),e?f.removeData("openedAnnotation"):(c.addClass("open"),c.find(".erratum-comment").slideDown("fast"),c.find(".erratum-comment").trigger("commentCollapsed",[d]),f.data("openedAnnotation",a.id)),g.publish("afterClick",d)}}),b||this.annotator.publish("annotationErrataUpdated",[a]),this},b.prototype._updateCounters=function(){return this.closedCount=this.closed.find(".annotator-erratum").length,this.pendingCount=this.pending.find(".annotator-erratum").length,this.closed.find("h2 .count").text(this.closedCount),
this.pending.find("h2 .count").text(this.pendingCount)},b.prototype.annotationsLoaded=function(a){var b,c,d,e,f;for(null==a&&(a=[]),c=function(a,b){return a.updated<b.updated?-1:a.updated>b.updated?1:0},this._setupSections(),f=a.sort(c),d=0,e=f.length;d<e;d++)b=f[d],this._setupComment(b,!0);return this.publish("annotationsErrataLoaded",[a]),this},b.prototype.annotationCreated=function(a){return this._setupComment(a),this},b.prototype.annotationDeleted=function(a){var b,c,d,e;return e=this,d=this.pending.find('[data-id="'+a.id+'"]'),d.length&&(a.deleted=!0),b=this.closed.find('[data-id="'+a.id+'"]'),b.length&&(a.deleted=!1),c=this.element.find('[data-id="'+a.id+'"]'),c.slideUp(function(){return c.remove(),e._setupComment(a),e.annotator.setupAnnotation(a)}),this},b.prototype.annotationUpdated=function(a){var b,c;return c=this,b=this.element.find('[data-id="'+a.id+'"]'),b.length&&b.slideUp(function(){return b.remove()}),this._setupComment(a),this},b.prototype.rangeNormalizeFail=function(a){return this.missing[a.id]=a.quote,this},b}(Delegator);var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};if(Annotator.Plugin.EEAGoogleChartsUnpivotAnnotation=function(a){function b(a,b){this.element=a,this.options=b,$(window).unbind("EEAGoogleChartsUnpivotAnnotation.events.inputChanged"),$(window).bind("EEAGoogleChartsUnpivotAnnotation.events.inputChanged",this.changeTextArea)}return __extends(b,a),b.prototype.pluginInit=function(){this.annotator.editor.addField({label:"dummyField",type:"input",load:this.overrideEditor}),this.annotator.viewer.addField({load:this.overrideViewer})},b.prototype.overrideEditor=function(a){var b,c;$(this.element).parent().find("textarea").attr("placeholder","").attr("readonly","readonly").css("color","transparent").addClass("hiddenAnnotatorTextArea"),b=$(".hiddenAnnotatorTextArea").attr("value"),c=jQuery(this.element).parent().find("textarea").parent(),c.closest(".annotator-listing").height("110px"),$(this.element).remove(),$(".googlechartAnnotationEditorTable").html(""),$(".googlechartAnnotationViewerTable").remove(),$("<table>").attr("style","position:relative; left:10px; top:-95px;").addClass("googlechartAnnotationEditorTable").appendTo(c),$("<tr>").addClass("googlechartAnnotationColumnType").appendTo(".googlechartAnnotationEditorTable"),$("<td>").text("Column Type").appendTo(".googlechartAnnotationColumnType"),$("<td>").html("<select>").appendTo(".googlechartAnnotationColumnType"),$("<option>").attr("value","base").text("base").appendTo(".googlechartAnnotationColumnType select"),$("<option>").attr("value","pivot").text("pivot").appendTo(".googlechartAnnotationColumnType select"),$("<tr>").addClass("googlechartAnnotationColumnName").appendTo(".googlechartAnnotationEditorTable"),$("<td>").text("Column Name").appendTo(".googlechartAnnotationColumnName"),$("<td>").html("<input type='text' style='padding:3px;margin-top:0px; height:30px; margin-bottom:5px;border:1px solid #cccccc'>").appendTo(".googlechartAnnotationColumnName"),$("<tr>").addClass("googlechartAnnotationValueType").appendTo(".googlechartAnnotationEditorTable"),$("<td>").text("Value Type").appendTo(".googlechartAnnotationValueType"),$("<td>").html("<select>").appendTo(".googlechartAnnotationValueType"),$("<option>").attr("value","string").text("string").appendTo(".googlechartAnnotationValueType select"),$("<option>").attr("value","number").text("number").appendTo(".googlechartAnnotationValueType select"),$("<option>").attr("value","date").text("date").appendTo(".googlechartAnnotationValueType select"),$(".googlechartAnnotationEditorTable select").bind("change",function(){$(window).trigger("EEAGoogleChartsUnpivotAnnotation.events.inputChanged")}),$(".googlechartAnnotationEditorTable input").bind("change",function(){$(window).trigger("EEAGoogleChartsUnpivotAnnotation.events.inputChanged")}),""!==b&&(b=JSON.parse(b),$(".googlechartAnnotationColumnType select").attr("value",b.colType),$(".googlechartAnnotationColumnName input").attr("value",b.colName),$(".googlechartAnnotationValueType select").attr("value",b.valType)),$(window).trigger("EEAGoogleChartsUnpivotAnnotation.events.inputChanged")},b.prototype.overrideViewer=function(a){var b,c;$(".googlechartAnnotationEditorTable").is(":visible")||(c=$(".annotator-widget.annotator-listing"),c.find(".eea-icon-edit").removeClass("eea-icon-edit").addClass("eea-icon-pencil"),c.find(".eea-icon-square-o").removeClass("eea-icon-square-o").addClass("eea-icon-trash-o"),c.find(".annotator-edit").height("18px"),c.find(".annotator-delete").height("18px"),b=JSON.parse(c.find("div:first").text()),c.find("div").remove(),$("<table style='margin:10px'>").addClass("googlechartAnnotationViewerTable").appendTo(c),$("<tr>").addClass("googlechartAnnotationColumnType").appendTo(".googlechartAnnotationViewerTable"),$("<td>").text("Column Type:").appendTo(".googlechartAnnotationColumnType"),$("<td style='font-weight:bold; padding-left:5px;'>").text(b.colType).appendTo(".googlechartAnnotationColumnType"),"base"!==b.colType&&($("<tr>").addClass("googlechartAnnotationColumnName").appendTo(".googlechartAnnotationViewerTable"),$("<td>").text("Column Name:").appendTo(".googlechartAnnotationColumnName"),$("<td style='font-weight:bold; padding-left:5px;'>").text(b.colName).appendTo(".googlechartAnnotationColumnName"),$("<tr>").addClass("googlechartAnnotationValueType").appendTo(".googlechartAnnotationViewerTable"),$("<td>").text("Value Type:").appendTo(".googlechartAnnotationValueType"),$("<td style='font-weight:bold; padding-left:5px;'>").text(b.valType).appendTo(".googlechartAnnotationValueType")))},b.prototype.changeTextArea=function(){var a,b,c,d;b=$(".googlechartAnnotationColumnType select option:selected").attr("value"),a=jQuery(".googlechartAnnotationColumnName input").attr("value"),d=jQuery(".googlechartAnnotationValueType select option:selected").attr("value"),c={},c.colType=b,c.colName=a,c.valType=d,$("li.annotator-item textarea").attr("value",JSON.stringify(c)),"base"===b?($(".googlechartAnnotationColumnName").hide(),$(".googlechartAnnotationValueType").hide()):($(".googlechartAnnotationColumnName").show(),$(".googlechartAnnotationValueType").show())},b.prototype.getAnnotations=function(){return $(".annotator-hl").addBack().map(function(){return $(this).data("annotation")})},b}(Annotator.Plugin),define("/home/davi/.buildout/eggs/eea.jquery-8.9-py2.7.egg/eea/jquery/plugins/annotator/annotator-full.js",function(){}),jQuery.fn.addBack||(jQuery.fn.addBack=jQuery.fn.andSelf),void 0===window.EEA)var EEA={who:"eea.annotator",version:"1.0"};EEA.eea_accordion||($.tools.tabs.addEffect("collapsed",function(a,b){}),EEA.eea_accordion=function(a){a||(a=$(".eea-accordion-panels")),a.length&&a.each(function(a,b){var c=$(b),d="slide",e="current",f=0,g=c.find(".pane");c.hasClass("collapsed-by-default")&&(d="slide",f=null,g.hide()),c.hasClass("non-exclusive")&&(c.hasClass("collapsed-by-default")||(g.not(":first").hide(),g.eq(0).prev().addClass("current")),d="collapsed",e="default",c.find(".eea-accordion-title, h2").click(function(a){var b=$(this);b.hasClass("current")?b.removeClass("current").next().slideUp():b.addClass("current").next().slideDown()})),c.tabs(g,{tabs:".eea-accordion-title, h2",effect:d,initialIndex:f,current:e,onBeforeClick:function(a,b){$(a.target).trigger("eea-accordion-before-click",{event:a,index:b})},onClick:function(a,b){$(a.target).trigger("eea-accordion-on-click",{event:a,index:b})}})})}),EEA.AnnotatorWorker={running:null,interval:0,latest:null,tries:3,callback:null,start:function(a,b,c,d){var e=this;return e.running?void e.log("auto-sync already running"):a<=0?void e.log("auto-sync is disabled"):(e.url=b,e.callback=d,e.log("auto-sync started. Running every "+a+"s"),a<1e3&&(a*=1e3),e.interval=a,e.running=!0,e.filter(c),void e.run())},stop:function(){var a=this;a.running&&(clearTimeout(a.running),a.running=null,a.log("auto-sync stopped"))},run:function(){var a=this;a.running=setTimeout(function(){jQuery.ajax({dataType:"json",url:a.url,data:{},success:function(b,c,d){return a.tries=3,b=a.filter(b),a.callback(b),a.run()},error:function(b,c,d){if(a.tries-=1,a.log("ERROR: "+d+" "+c+". Remaining tries: "+a.tries),a.tries>0)return a.run()}})},a.interval)},filter:function(a){var b,c=this;if(!c.latest)return jQuery.each(a,function(a,d){b=d.updated.endsWith("Z")?d.updated:d.updated+"Z",c.latest?b>c.latest&&(c.latest=b):c.latest=b}),a;var d=c.latest,e=jQuery.map(a,function(a,e){return b=a.updated.endsWith("Z")?a.updated:a.updated+"Z",b>c.latest?(b>d&&(d=b),a):null});return c.latest=d,e},log:function(a){window.console&&console.log("eea.annotator: "+a)}},EEA.Annotator=function(a,b){var c=this;c.context=a,c.target=jQuery("#content");var d=c.context.find('input[name="_authenticator"]');d=d?d.val():"",c.settings={readOnly:c.context.data("readonly")||0,autoSync:c.context.data("autosync")||0,noDuplicates:c.context.data("noduplicates")||!1,minWords:c.context.data("minwords")||0,authenticator:d,history:!0,worker:"",prefix:"",user:{id:c.context.data("userid")||"anonymous",name:c.context.data("username")||"Anonymous"},urls:{create:"/annotations_edit",read:"/annotations_view/:id",update:"/annotations_edit/:id",destroy:"/annotations_edit/:id",search:"/annotations_search"}},b&&jQuery.extend(c.settings,b),c.initialize()},EEA.Annotator.prototype={initialize:function(){var a=this;a.button=a.context.find(".annotator-button"),a.button.attr("title",a.button.data("hide")),a.enabled=!0,a.button.click(function(b){return b.preventDefault(),a.click()}),a.worker=EEA.AnnotatorWorker,a.reload()},click:function(){var a=this;a.enabled?(a.enabled=!1,a.button.addClass("annotator-disabled"),a.button.attr("title",a.button.data("show")),a.target.annotator("destroy"),a.worker.stop()):(a.enabled=!0,a.button.removeClass("annotator-disabled"),a.button.attr("title",a.button.data("hide")),a.reload())},reload:function(){var a=this;a.target.annotator({readOnly:Boolean(a.settings.readOnly),exactMatch:!0,noDuplicates:Boolean(a.settings.noDuplicates),minWords:parseInt(a.settings.minWords,10),authenticator:a.settings.authenticator}),a.target.annotator("addField",{load:function(a,b){var c=b.created;if(c){c.endsWith("Z")&&(c+="Z");var d=new Date(c),e=Util.easyDate(d);$(a).html(e).addClass("annotator-date").attr("title",Util.prettyDateString(d))}}}),a.target.annotator("addPlugin","Permissions",{user:a.settings.user,userId:function(a){return a&&a.id?a.id:a},userString:function(a){return Util.userString(a)},permissions:{read:[],update:[a.settings.user.id],"delete":[],admin:[a.settings.user.id]},showViewPermissionsCheckbox:!1,showEditPermissionsCheckbox:!1}),a.target.annotator("addPlugin","Comment"),a.target.annotator("addPlugin","Store",{prefix:a.settings.prefix,urls:a.settings.urls,history:a.settings.history}),a.target.annotator("addPlugin","Errata"),a.target.off(".Annotator"),a.target.on("afterAnnotationsLoaded.Annotator",function(b,c){c=c?c:[],a.worker.start(a.settings.autoSync,a.settings.worker,c,function(b){if(b.length)return a.sync(b)})}),a.target.on("annotationErrataUpdated.Annotator",function(b,c){c.length||(c=[c]),a.worker.filter(c)})},sync:function(a){var b=this;b.target.annotator("refreshAnnotations",a)}},jQuery.fn.EEAAnnotator=function(a){return this.each(function(){var b=jQuery(this),c=new EEA.Annotator(b,a);b.data("EEAAnnotator",c)})},EEA.AnnotatorPortlet=function(a,b){var c=this;c.context=a,c.settings={},b&&jQuery.extend(c.settings,b),c.initialize()},EEA.AnnotatorPortlet.prototype={initialize:function(){var a=this;a.header=a.context.find(".portletHeader"),a.parent=a.context.parent(),a.width=a.context.width(),a.subscribe=a.context.find(".annotator-subscription-button"),a.authenticator=a.header.find('input[name="_authenticator"]').val(),a.subscribe.click(function(b){b.preventDefault(),a.onSubscribe(b)});var b=a.context.find(".annotator-errata");b.off(".AnnotatorPortlet"),b.on("beforeClick.AnnotatorPortlet",function(b,c){return a.context.hasClass("fullscreen")?a.highlight(c.annotation,c.element):a.fullscreen(c.annotation,c.element)}),b.on("annotationsErrataLoaded.AnnotatorPortlet",function(a,c){EEA.eea_accordion(b)}),jQuery("<a>").addClass("annotator-fullscreen-button").attr("title","Toggle Full Screen Mode").html(jQuery("<span>").addClass("eea-icon").addClass("eea-icon-expand")).prependTo(a.header),a.header.find(".annotator-fullscreen-button").click(function(b){b.preventDefault(),a.fullscreen()}),jQuery(".annotator-portlet").on("commentCollapsed",".erratum-comment",function(a,b){if("undefined"!=typeof tinymce){var c=b.annotation.quote;c=c.split("\n");var d=tinymce.editors;jQuery.each(d,function(){var a=this;a.selection.select(a.getBody(),!0),a.selection.collapse(!0);for(var b,d=a.selection,e=0,f=c.length;e<f;e++)if(c[e].length>0){var g=a.getWin(),h=g.find(c[e]);if(h===!0){var i=d.getRng(),j=$("#"+a.editorId).closest(".formPanel"),k=j.find("legend").attr("id");jQuery("a#"+k).click(),jQuery("html, body").animate({scrollTop:jQuery("#"+a.editorId).parent().offset().top}),a.focus(),0===e&&(b=i.cloneRange()),b.setEnd(i.startContainer,i.endOffset),d.setRng(b)}}})}}),jQuery(".annotator-portlet").on("commentUnCollapsed",".erratum-comment",function(a,b){if("undefined"!=typeof tinymce){var c=tinymce.activeEditor;c.execCommand("SelectAll"),c.selection.collapse(!0)}}),jQuery(".annotator-portlet").on("portletEnterFS",function(a){var b=jQuery(this),c=(b.find(".portletHeader"),b.outerWidth(!0));jQuery(window).scrollTop()+Math.floor(jQuery(window).height()/2);b.addClass("unslided");var d=jQuery("<div />",{"class":"annotator-slide-button slide-right",click:function(a){var d=b,e=jQuery(this),f=e.find(".eea-icon");a.preventDefault(),d.hasClass("unslided")?d.animate({"margin-right":"-="+c},function(){d.css("overflow","visible"),d.removeClass("unslided").addClass("slided"),e.removeClass("slide-right").addClass("slide-left"),e.css("right",c),f.removeClass("eea-icon-caret-right").addClass("eea-icon-caret-left")}):d.animate({"margin-right":"+="+c},function(){d.css("overflow",""),d.removeClass("slided").addClass("unslided"),e.removeClass("slide-left").addClass("slide-right"),f.removeClass("eea-icon-caret-left").addClass("eea-icon-caret-right")})}}),e=jQuery("<span />",{"class":"eea-icon eea-icon-caret-right eea-icon-2x",title:"Slide the portlet to the right"});e.appendTo(d),d.width((c-b.width())/2),b.append(d)}),jQuery(".annotator-portlet").on("portletExitFS",function(a){var b=jQuery(this),c=b.find(".annotator-slide-button");c.remove()})},fullscreen:function(a,b){var c=this,d=c.header.find(".annotator-fullscreen-button span");c.context.hasClass("fullscreen")?c.context.slideUp(function(){d.removeClass("eea-icon-compress"),d.addClass("eea-icon-expand"),c.context.removeClass("fullscreen"),c.context.width("auto"),c.context.slideDown("fast"),c.context.trigger("portletExitFS")}):c.context.slideUp(function(){if(d.addClass("eea-icon-compress"),d.removeClass("eea-icon-expand"),c.context.addClass("fullscreen"),c.context.width(c.width),c.context.slideDown("fast"),c.highlight(a,b),b&&b.position){var e=b.position().top;c.context.animate({scrollTop:e})}c.context.trigger("portletEnterFS")})},highlight:function(a,b){var c=[];a&&a.highlights&&(c=a.highlights),jQuery(".annotator-hl").removeClass("hover"),jQuery.each(c,function(a,b){if(0===a){var c=jQuery(b).position().top;jQuery("html,body").animate({scrollTop:c})}jQuery(b).addClass("hover")})},onSubscribe:function(a){var b=this,c=b.subscribe.attr("href");jQuery.ajax({type:"post",url:c,data:{ajax:!0},beforeSend:function(a,c){a.setRequestHeader("X-CSRF-Token",b.authenticator)},success:function(a){b.afterSubscribe(a)}})},afterSubscribe:function(a){var b=this;b.subscribe.hasClass("annotator-subscribe")?(b.subscribe.removeClass("annotator-subscribe").addClass("annotator-unsubscribe").attr({title:b.header.data("unsubscribetitle"),href:b.header.data("unsubscribehref")}),b.subscribe.find(".eea-icon").attr({"class":b.header.data("unsubscribeicon")})):(b.subscribe.removeClass("annotator-unsubscribe").addClass("annotator-subscribe").attr({title:b.header.data("subscribetitle"),href:b.header.data("subscribehref")}),b.subscribe.find(".eea-icon").attr({"class":b.header.data("subscribeicon")})),Annotator.showNotification(a,Annotator.Notification.SUCCESS)}},jQuery.fn.EEAAnnotatorPortlet=function(a){return this.each(function(){var b=jQuery(this),c=new EEA.AnnotatorPortlet(b,a);b.data("EEAAnnotatorPortlet",c)})},jQuery(document).ready(function(){var a=jQuery(".eea-annotator");if(a.length){var b=jQuery("base").attr("href");b||(b=jQuery("body").data("base-url")),b.endsWith("/")&&(b=b.substring(0,b.length-1));var c={worker:b+"/annotator.api/annotations_view",prefix:b+"/annotator.api"};a.EEAAnnotator(c)}a=jQuery(".annotator-portlet"),a.length&&a.EEAAnnotatorPortlet()}),define("/home/davi/Projetos/smdu/smdu.participacao/src/eea.annotator/eea/annotator/browser/js/view.js",function(){});
//# sourceMappingURL=eea.annotator-compiled.js.map
